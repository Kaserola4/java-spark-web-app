<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.pikolinc</groupId>
    <artifactId>java-spark-web-app</artifactId>
    <version>1.0-SNAPSHOT</version>

    <properties>
        <maven.compiler.source>17</maven.compiler.source>
        <maven.compiler.target>17</maven.compiler.target>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <main.class>com.pikolinc.JavaSparkWebApp</main.class>
    </properties>

    <build>
        <resources>
            <resource>
                <directory>src/main/resources</directory>
            </resource>
        </resources>

        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <configuration>
                    <source>17</source>
                    <target>17</target>

                    <annotationProcessorPaths>
                        <path>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                            <version>1.18.42</version>
                        </path>
                    </annotationProcessorPaths>
                </configuration>
            </plugin>

            <plugin>
                <groupId>org.codehaus.mojo</groupId>
                <artifactId>exec-maven-plugin</artifactId>
                <version>3.1.0</version>
                <configuration>
                    <mainClass>${main.class}</mainClass>
                </configuration>
            </plugin>

            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-shade-plugin</artifactId>
                <version>3.5.1</version>
                <executions>
                    <execution>
                        <phase>package</phase>
                        <goals>
                            <goal>shade</goal>
                        </goals>
                        <configuration>
                            <transformers>
                                <transformer implementation="org.apache.maven.plugins.shade.resource.ManifestResourceTransformer">
                                    <mainClass>${main.class}</mainClass>
                                </transformer>
                            </transformers>
                            <filters>
                                <filter>
                                    <artifact>*:*</artifact>
                                    <excludes>
                                        <exclude>META-INF/*.SF</exclude>
                                        <exclude>META-INF/*.DSA</exclude>
                                        <exclude>META-INF/*.RSA</exclude>
                                    </excludes>
                                </filter>
                            </filters>
                        </configuration>
                    </execution>
                </executions>
            </plugin>
        </plugins>
    </build>

    <dependencies>
        <dependency>
            <groupId>com.sparkjava</groupId>
            <artifactId>spark-core</artifactId>
            <version>2.9.4</version>
        </dependency>
        <dependency>
            <groupId>ch.qos.logback</groupId>
            <artifactId>logback-classic</artifactId>
            <version>1.5.20</version>
            <scope>compile</scope>
        </dependency>
        <dependency>
            <groupId>com.google.code.gson</groupId>
            <artifactId>gson</artifactId>
            <version>2.13.2</version>
        </dependency>

        <dependency>
            <groupId>com.h2database</groupId>
            <artifactId>h2</artifactId>
            <version>2.3.232</version>
            <scope>runtime</scope>
        </dependency>

        <dependency>
            <groupId>org.jdbi</groupId>
            <artifactId>jdbi3-core</artifactId>
            <version>3.49.6</version>
        </dependency>

        <dependency>
            <groupId>org.jdbi</groupId>
            <artifactId>jdbi3-sqlobject</artifactId>
            <version>3.49.6</version>
        </dependency>

        <dependency>
            <groupId>org.slf4j</groupId>
            <artifactId>slf4j-api</artifactId>
            <version>2.0.17</version>
        </dependency>

        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <version>1.18.42</version>
            <scope>provided</scope>
        </dependency>

        <dependency>
            <groupId>io.github.cdimascio</groupId>
            <artifactId>java-dotenv</artifactId>
            <version>5.2.2</version>
        </dependency>

        <dependency>
            <groupId>jakarta.validation</groupId>
            <artifactId>jakarta.validation-api</artifactId>
            <version>3.0.1</version>
        </dependency>

        <dependency>
            <groupId>org.hibernate</groupId>
            <artifactId>hibernate-validator</artifactId>
            <version>7.0.2.Final</version>
        </dependency>

        <dependency>
            <groupId>jakarta.el</groupId>
            <artifactId>jakarta.el-api</artifactId>
            <version>5.0.1</version>
        </dependency>

        <dependency>
            <groupId>org.glassfish.expressly</groupId>
            <artifactId>expressly</artifactId>
            <version>5.0.0</version>
        </dependency>

        <dependency>
            <groupId>com.sparkjava</groupId>
            <artifactId>spark-template-mustache</artifactId>
            <version>2.7.1</version>
        </dependency>
    </dependencies>
</project>
# Java Spark Web Application

- A RESTful web application built with Java and Spark framework for managing collectible items.
- Website with real-time collectible updates

This project demonstrates modern Java web development practices with a clean architecture and robust API design.

The architecture follows a layered approach to separate concerns and improve maintainability. At the top, the HTTP
client or browser interacts with the application, sending requests to the server. These requests are first handled by
the Spark framework, which is responsible for routing and mapping requests to the appropriate controller endpoints. The
RoutesInitializer sets up all the routes, connecting the HTTP layer with the controller layer.

The controller layer is responsible for handling incoming requests, parsing JSON input, validating data, and delegating
the processing to the service layer. For example, the UserApiController manages all user-related requests, ensuring that
input is correctly validated and that responses are formatted properly before sending them back to the client.

The service layer contains the core business logic of the application. Classes like UserService and UserServiceImpl
perform validations, handle transactions, and convert between DTOs and entity models. This layer ensures that the
business rules are applied consistently and abstracts the database operations from the controllers. It also manages the
logic for real-time updates, pushing changes for bids or collectible status to connected clients.

Beneath the service layer is the DAO (Data Access Object) layer, which directly interacts with the database. UserDao and
other DAO classes handle all CRUD operations, query building, and execution, while extending base classes that manage
database connections. This layer encapsulates all the database logic, providing a clean interface for the service layer
to use.

Finally, the database layer stores all persistent data. This project supports any SQL database, such as PostgreSQL,
MySQL, or H2, and all queries are executed through the DAO layer. By keeping the database interactions separate from
business logic and request handling, the application achieves a high degree of modularity and testability.

Overall, this project serves as an example of a well-structured Java web application, combining Spark framework routing,
controller-based request handling, service-layer business logic, DAO-driven database operations, SQL persistence, and
real-time updates for collectibles and bidding into a cohesive and maintainable system.

# Installation and setup
```bash
git clone https://github.com/Kaserola4/java-spark-web-app.git
cd ./java-spark-web-app/

mvn clean install
mvn exec:java

```
<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CompilerConfiguration">
    <annotationProcessing>
      <profile default="true" name="Default" enabled="true" />
      <profile name="Maven default annotation processors profile" enabled="true">
        <sourceOutputDir name="target/generated-sources/annotations" />
        <sourceTestOutputDir name="target/generated-test-sources/test-annotations" />
        <outputRelativeToContentRoot value="true" />
      </profile>
      <profile name="Annotation profile for java-spark-web-app" enabled="true">
        <sourceOutputDir name="target/generated-sources/annotations" />
        <sourceTestOutputDir name="target/generated-test-sources/test-annotations" />
        <outputRelativeToContentRoot value="true" />
        <processorPath useClasspath="false">
          <entry name="$MAVEN_REPOSITORY$/org/projectlombok/lombok/1.18.42/lombok-1.18.42.jar" />
        </processorPath>
        <module name="java-spark-web-app" />
      </profile>
    </annotationProcessing>
  </component>
</project>
<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="Encoding">
    <file url="file://$PROJECT_DIR$/src/main/java" charset="UTF-8" />
    <file url="file://$PROJECT_DIR$/src/main/resources" charset="UTF-8" />
  </component>
</project>
<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="RemoteRepositoriesConfiguration">
    <remote-repository>
      <option name="id" value="central" />
      <option name="name" value="Central Repository" />
      <option name="url" value="https://repo.maven.apache.org/maven2" />
    </remote-repository>
    <remote-repository>
      <option name="id" value="central" />
      <option name="name" value="Maven Central repository" />
      <option name="url" value="https://repo1.maven.org/maven2" />
    </remote-repository>
    <remote-repository>
      <option name="id" value="jboss.community" />
      <option name="name" value="JBoss Community repository" />
      <option name="url" value="https://repository.jboss.org/nexus/content/repositories/public/" />
    </remote-repository>
  </component>
</project>
<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="ComposerSettings">
    <execution />
  </component>
  <component name="ExternalStorageConfigurationManager" enabled="true" />
  <component name="MavenProjectsManager">
    <option name="originalFiles">
      <list>
        <option value="$PROJECT_DIR$/pom.xml" />
      </list>
    </option>
  </component>
  <component name="ProjectRootManager" version="2" languageLevel="JDK_17" default="true" project-jdk-name="ms-17" project-jdk-type="JavaSDK">
    <output url="file://$PROJECT_DIR$/out" />
  </component>
</project>
<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="VcsDirectoryMappings">
    <mapping directory="$PROJECT_DIR$" vcs="Git" />
  </component>
</project>
<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="AutoImportSettings">
    <option name="autoReloadType" value="SELECTIVE" />
  </component>
  <component name="ChangeListManager">
    <list default="true" id="0715ad32-75d7-4eb9-b7f7-4a82751e52ab" name="Changes" comment="" />
    <option name="SHOW_DIALOG" value="false" />
    <option name="HIGHLIGHT_CONFLICTS" value="true" />
    <option name="HIGHLIGHT_NON_ACTIVE_CHANGELIST" value="false" />
    <option name="LAST_RESOLUTION" value="IGNORE" />
  </component>
  <component name="FileTemplateManagerImpl">
    <option name="RECENT_TEMPLATES">
      <list>
        <option value="Exception" />
        <option value="Record" />
        <option value="JavaScript File" />
        <option value="Enum" />
        <option value="Interface" />
        <option value="Class" />
      </list>
    </option>
  </component>
  <component name="Git.Settings">
    <option name="RECENT_GIT_ROOT_PATH" value="$PROJECT_DIR$" />
  </component>
  <component name="GitHubPullRequestSearchHistory">{
  &quot;lastFilter&quot;: {
    &quot;state&quot;: &quot;OPEN&quot;,
    &quot;assignee&quot;: &quot;Kaserola4&quot;
  }
}</component>
  <component name="GithubPullRequestsUISettings">{
  &quot;selectedUrlAndAccountId&quot;: {
    &quot;url&quot;: &quot;https://github.com/kaserola4/java-spark-web-app.git&quot;,
    &quot;accountId&quot;: &quot;60e74033-b6eb-4c42-954f-c22fdb25e152&quot;
  }
}</component>
  <component name="ProjectColorInfo">{
  &quot;associatedIndex&quot;: 4
}</component>
  <component name="ProjectId" id="34V09ckRgTF6wJsPaE1jcs9n2JF" />
  <component name="ProjectViewState">
    <option name="hideEmptyMiddlePackages" value="true" />
    <option name="showLibraryContents" value="true" />
  </component>
  <component name="PropertiesComponent"><![CDATA[{
  "keyToString": {
    "Application.JavaSparkWebApp.executor": "Run",
    "JAR Application.java-spark-web-app-1.0-SNAPSHOT.jar.executor": "Run",
    "ModuleVcsDetector.initialDetectionPerformed": "true",
    "Notification.DisplayName-DoNotAsk-WindowsDefender": "Microsoft Defender may affect IDE",
    "Notification.DoNotAsk-WindowsDefender": "true",
    "RunOnceActivity.ShowReadmeOnStart": "true",
    "RunOnceActivity.TerminalTabsStorage.copyFrom.TerminalArrangementManager.252": "true",
    "RunOnceActivity.git.unshallow": "true",
    "SHARE_PROJECT_CONFIGURATION_FILES": "true",
    "com.intellij.ml.llm.matterhorn.ej.ui.settings.DefaultModelSelectionForGA.v1": "true",
    "git-widget-placeholder": "docs",
    "ignore.virus.scanning.warn.message": "true",
    "junie.onboarding.icon.badge.shown": "true",
    "kotlin-language-version-configured": "true",
    "node.js.detected.package.eslint": "true",
    "node.js.detected.package.tslint": "true",
    "node.js.selected.package.eslint": "(autodetect)",
    "node.js.selected.package.tslint": "(autodetect)",
    "nodejs_package_manager_path": "npm",
    "onboarding.tips.debug.path": "C:/code-repos/digital-nao-challenge-3/java-spark-web-app/src/main/java/com/pikolinc/Main.java",
    "project.structure.last.edited": "Modules",
    "project.structure.proportion": "0.15",
    "project.structure.side.proportion": "0.2",
    "to.speed.mode.migration.done": "true"
  }
}]]></component>
  <component name="RunManager" selected="Application.JavaSparkWebApp">
    <configuration name="JavaSparkWebApp" type="Application" factoryName="Application" temporary="true" nameIsGenerated="true">
      <option name="MAIN_CLASS_NAME" value="com.pikolinc.JavaSparkWebApp" />
      <module name="java-spark-web-app" />
      <extension name="coverage">
        <pattern>
          <option name="PATTERN" value="com.pikolinc.*" />
          <option name="ENABLED" value="true" />
        </pattern>
      </extension>
      <method v="2">
        <option name="Make" enabled="true" />
      </method>
    </configuration>
    <configuration name="java-spark-web-app-1.0-SNAPSHOT.jar" type="JarApplication" temporary="true">
      <option name="JAR_PATH" value="$PROJECT_DIR$/target/java-spark-web-app-1.0-SNAPSHOT.jar" />
      <method v="2" />
    </configuration>
    <recent_temporary>
      <list>
        <item itemvalue="Application.JavaSparkWebApp" />
        <item itemvalue="JAR Application.java-spark-web-app-1.0-SNAPSHOT.jar" />
      </list>
    </recent_temporary>
  </component>
  <component name="SharedIndexes">
    <attachedChunks>
      <set>
        <option value="bundled-jdk-9823dce3aa75-bf35d07a577b-intellij.indexing.shared.core-IU-252.25557.131" />
      </set>
    </attachedChunks>
  </component>
  <component name="TaskManager">
    <task active="true" id="Default" summary="Default task">
      <changelist id="0715ad32-75d7-4eb9-b7f7-4a82751e52ab" name="Changes" comment="" />
      <created>1761283285047</created>
      <option name="number" value="Default" />
      <option name="presentableId" value="Default" />
      <updated>1761283285047</updated>
      <workItem from="1761283286551" duration="15608000" />
      <workItem from="1761372229427" duration="12247000" />
      <workItem from="1761432847730" duration="14267000" />
      <workItem from="1761609556803" duration="15095000" />
      <workItem from="1761673700156" duration="67570000" />
      <workItem from="1761960775864" duration="15295000" />
      <workItem from="1762105727793" duration="5832000" />
    </task>
    <servers />
  </component>
  <component name="TypeScriptGeneratedFilesManager">
    <option name="version" value="3" />
  </component>
  <component name="UnknownFeatures">
    <option featureType="dependencySupport" implementationName="java:org.jdbi:jdbi3-core" />
  </component>
  <component name="Vcs.Log.Tabs.Properties">
    <option name="TAB_STATES">
      <map>
        <entry key="MAIN">
          <value>
            <State />
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>
package com.pikolinc;

import com.pikolinc.app.ServerInitializer;

public class JavaSparkWebApp {
    public static void main(String[] args) {
        ServerInitializer.run();
    }
}
package com.pikolinc.app;

import com.pikolinc.app.initializer.*;
import com.pikolinc.app.initializer.config.DatabaseInitializer;
import com.pikolinc.config.Env;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import spark.Spark;

import java.util.List;

public class ServerInitializer {
    private static final Logger logger = LoggerFactory.getLogger(ServerInitializer.class);

    public static void run() {
        int port = Integer.parseInt(Env.get("PORT", "8080"));
        Spark.port(port);
        Spark.staticFiles.location("/public");

        List<Initializer> initializers = List.of(
                new DatabaseInitializer(),
                new EventListenersInitializer(),
                new WebsocketInitializer(),
                new ExceptionHandlerInitializer(),
                new MiddlewaresInitializer(),
                new RoutesInitializer()
        );

        try {
            for (Initializer initializer : initializers) {
                logger.info("ðŸš€ Running initializer: {}", initializer.name());
                initializer.init();
            }

            Spark.init();
            Spark.awaitInitialization();
        } catch (Exception e) {
            logger.error("âŒ Server failed to start due to initializer error", e);
            Spark.stop();
            return;
        }

        logger.info("ðŸš€ Application started on port {}", port);
        addShutdownHook();
    }

    private static void addShutdownHook() {
        Runtime.getRuntime().addShutdownHook(new Thread(() -> {
            Spark.stop();
            logger.info("ðŸ§¹ Server stopped cleanly");
        }));
    }
}
package com.pikolinc.app.initializer;

import com.pikolinc.infraestructure.events.listeners.EventListener;
import com.pikolinc.infraestructure.events.listeners.ItemsEventListener;
import com.pikolinc.infraestructure.events.listeners.OffersEventListener;
import java.util.List;

public class EventListenersInitializer implements Initializer {
    @Override
    public void init() {
        List<EventListener>  eventListeners = List.of(
                new OffersEventListener(),
                new ItemsEventListener()
        );

        eventListeners.forEach(EventListener::listen);
    }
}
package com.pikolinc.app.initializer;

import com.google.gson.Gson;
import com.google.gson.JsonSyntaxException;
import com.pikolinc.exceptions.ValidationException;
import com.pikolinc.exceptions.api.ApiResourceNotFoundException;
import com.pikolinc.exceptions.api.DuplicateResourceException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import spark.Spark;

import java.util.HashMap;
import java.util.Map;

public class ExceptionHandlerInitializer implements Initializer {
    private static final Logger logger = LoggerFactory.getLogger(ExceptionHandlerInitializer.class);
    private static final Gson gson = new Gson();

    @Override
    public void init() {
        initGenericExceptionHandler();
        initValidationExceptionHandler();
        initApiExceptionHandler();
    }

    private void initApiExceptionHandler() {
        // 404 (Not found)
        Spark.exception(ApiResourceNotFoundException.class, (e, req, res) -> {
            logger.warn("Resource not found: {}", e.getMessage());
            sendJsonResponse(res, 404, "Not Found", e.getMessage());
        });

        // 400 (Bad Request) - malformed or invalid JSON
        Spark.exception(JsonSyntaxException.class, (e, req, res) -> {
            logger.warn("Malformed Json: {}", e.getMessage());
            String cleanMessage = "Malformed or invalid JSON. Please check your request body syntax.";
            sendJsonResponse(res, 400, "Bad Request", cleanMessage);
        });

        // 409 (Duplicated Resource)
        Spark.exception(DuplicateResourceException.class, (e, req, res) -> {
            logger.warn("Attempted to create duplicated resource: {}", e.getMessage());
            sendJsonResponse(res, 409, "Validation failed", e.getMessage());
        });
    }

    private void initValidationExceptionHandler() {
        // 400 (Bad Request)
        Spark.exception(ValidationException.class, (e, req, res) -> {
            logger.warn("Validation failed: {}", e.getErrors());
            res.type("application/json");
            res.status(400);

            Map<String, Object> response = new HashMap<>();
            response.put("error", "Validation failed");
            response.put("details", e.getErrors());

            res.body(gson.toJson(response));
        });
    }

    private void initGenericExceptionHandler() {
        Spark.exception(RuntimeException.class, (e, req, res) -> {
            logger.error("Unhandled exception", e);
            sendJsonResponse(res, 500, "Internal Server Error", "An unexpected error occurred");
        });
    }

    private void sendJsonResponse(spark.Response res, int status, String error, String message) {
        res.type("application/json");
        res.status(status);

        Map<String, Object> response = new HashMap<>();
        response.put("error", error);
        response.put("message", message);

        res.body(gson.toJson(response));
    }
}
package com.pikolinc.app.initializer;

public interface Initializer {
    void init();
    default String name(){
        return this.getClass().getSimpleName();
    }

}
package com.pikolinc.app.initializer;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import spark.Spark;

public class MiddlewaresInitializer implements Initializer {
    private static final Logger logger = LoggerFactory.getLogger(MiddlewaresInitializer.class);

    @Override
    public void init() {
        Spark.before("/*", (request, response) -> {
            response.header("Access-Control-Allow-Origin", "*");
            response.type("text/html");
        });
        Spark.before("/api/v1/*", (request, response) -> {
            response.header("Access-Control-Allow-Origin", "*");
            response.header("Access-Control-Allow-Methods", "GET,POST,PUT,DELETE,OPTIONS");
            response.type("application/json");
            logger.info("Incoming API request: {} {}", request.requestMethod(), request.pathInfo());
        });


        Spark.afterAfter((request, response) -> {
            logger.info("Completed {} {} with status {}", request.requestMethod(), request.pathInfo(), response.status());
        });
    }
}
package com.pikolinc.app.initializer;

import com.pikolinc.controllers.api.ItemApiController;
import com.pikolinc.controllers.api.OfferApiController;
import com.pikolinc.controllers.api.UserApiController;
import com.pikolinc.routes.api.ItemApiRouter;
import com.pikolinc.routes.api.OfferApiRouter;
import com.pikolinc.routes.api.Router;
import com.pikolinc.routes.api.UserApiRouter;
import com.pikolinc.routes.web.WebRouter;
import com.pikolinc.services.ItemService;
import com.pikolinc.services.OfferService;
import com.pikolinc.services.UserService;
import com.pikolinc.services.impl.ItemServiceImpl;
import com.pikolinc.services.impl.OfferServiceImpl;
import com.pikolinc.services.impl.UserServiceImpl;
import spark.Spark;

import java.util.List;

public class RoutesInitializer implements Initializer {
    @Override
    public void init() {

        UserService userService = new UserServiceImpl();
        ItemService itemService = new ItemServiceImpl();
        OfferService offerService = new OfferServiceImpl(itemService, userService);

        UserApiController userController = new UserApiController(userService);
        ItemApiController itemController = new ItemApiController(itemService);
        OfferApiController offerController = new OfferApiController(offerService);

        List<Router> routers = List.of(
                new UserApiRouter(userController),
                new ItemApiRouter(itemController),
                new OfferApiRouter(offerController),
                new WebRouter()
        );

        routers.forEach(Router::registerRoutes);

        Spark.get("/health", (req, res) -> "OK");
    }
}
package com.pikolinc.app.initializer;

import com.pikolinc.ws.ItemListWebsocketHandler;
import com.pikolinc.ws.OfferWebSocketHandler;
import spark.Spark;

public class WebsocketInitializer implements Initializer{
    @Override
    public void init() {
        Spark.webSocket("/ws", ItemListWebsocketHandler.class);
        Spark.webSocket("/ws/offers", OfferWebSocketHandler.class);
    }
}
package com.pikolinc.app.initializer.config;


import com.pikolinc.app.initializer.Initializer;
import com.pikolinc.dao.ItemDao;
import com.pikolinc.dao.OfferDao;
import com.pikolinc.dao.UserDao;
import lombok.Getter;
import org.jdbi.v3.core.Jdbi;
import org.jdbi.v3.sqlobject.SqlObjectPlugin;

public class DatabaseInitializer implements Initializer {
    @Getter
    private static Jdbi jdbi;

    @Override
    public void init(){
        jdbi = Jdbi.create(
                "jdbc:h2:mem:spark;DB_CLOSE_DELAY=-1",
                "sa",
                ""
        );

        jdbi.installPlugin(new SqlObjectPlugin());

        jdbi.useExtension(UserDao.class, UserDao::createTable);
        jdbi.useExtension(ItemDao.class, ItemDao::createTable);
        jdbi.useExtension(OfferDao.class,  OfferDao::createTable);

        jdbi.useExtension(UserDao.class,  UserDao::insertSampleData);
        jdbi.useExtension(ItemDao.class,  ItemDao::insertSampleData);


    }
}
package com.pikolinc.config;

import io.github.cdimascio.dotenv.Dotenv;

public class Env {
    private static final Dotenv dotenv = Dotenv.configure()
            .ignoreIfMissing()
            .load();

    public static String get(String key, String defaultValue) {
        String value = System.getenv(key);
        if (value == null || value.isEmpty()) {
            value = dotenv.get(key);
        }
        return value != null ? value : defaultValue;
    }
}
package com.pikolinc.controllers.api;

import com.google.gson.Gson;
import com.pikolinc.services.ItemService;
import com.pikolinc.util.ValidationUtil;
import spark.Request;
import spark.Response;

import com.pikolinc.dto.request.ItemCreateDto;

public class ItemApiController {
    private final ItemService itemService;
    private final Gson gson;

    public ItemApiController(ItemService itemService) {
        this.gson = new Gson();
        this.itemService = itemService;
    }

    public Object findAll(Request request, Response response) {
        return this.gson.toJson(this.itemService.findAll());
    }

    public Object findById(Request request, Response response) {
        return this.gson.toJson(this.itemService.findById(Long.parseLong(request.params(":id"))));
    }

    public long insert(Request request, Response response) {
        ValidationUtil.validateNotEmptyBody(request.body());
        return this.itemService.insert(gson.fromJson(request.body(), ItemCreateDto.class));
    }

    public long update(Request request, Response response) {
        ValidationUtil.validateNotEmptyBody(request.body());
        long id = ValidationUtil.validateParamFormat(":id", request.params(":id"), Long.class);
        return this.itemService.update(id, gson.fromJson(request.body(), ItemCreateDto.class));
    }

    public long delete(Request request, Response response) {
        long id = ValidationUtil.validateParamFormat(":id", request.params(":id"), Long.class);
        return this.itemService.delete(id);
    }

    public Object options(Request request, Response response) {
        long id = ValidationUtil.validateParamFormat(":id", request.params(":id"), Long.class);
        return gson.toJson(this.itemService.options(id));
    }
}
package com.pikolinc.controllers.api;

import com.google.gson.Gson;
import com.pikolinc.domain.OfferStatus;
import com.pikolinc.dto.request.OfferCreateDto;
import com.pikolinc.dto.request.OfferRebidDto;
import com.pikolinc.dto.request.OfferUpdateDto;
import com.pikolinc.exceptions.ValidationException;
import com.pikolinc.services.OfferService;
import com.pikolinc.util.ValidationUtil;
import spark.Request;
import spark.Response;

import java.util.Map;

public class OfferApiController {
    private final OfferService offerService;
    private final Gson gson;

    public OfferApiController(OfferService offerService) {
        this.gson = new Gson();
        this.offerService = offerService;
    }

    public Object findAll(Request request, Response response) {
        return this.gson.toJson(this.offerService.findAll());
    }

    public Object findById(Request request, Response response) {
        long id = ValidationUtil.validateParamFormat(":id", request.params(":id"), Long.class);
        return this.gson.toJson(this.offerService.findById(id));
    }

    public Object insert(Request request, Response response) {
        ValidationUtil.validateNotEmptyBody(request.body());
        return this.offerService.insert(gson.fromJson(request.body(), OfferCreateDto.class));
    }

    public Object update(Request request, Response response) {
        ValidationUtil.validateNotEmptyBody(request.body());
        long id = ValidationUtil.validateParamFormat(":id", request.params(":id"), Long.class);
        return this.offerService.update(id, gson.fromJson(request.body(), OfferUpdateDto.class));
    }

    public Object delete(Request request, Response response) {
        long id = ValidationUtil.validateParamFormat(":id", request.params(":id"), Long.class);
        return this.offerService.delete(id);
    }

    public Object options(Request request, Response response) {
        response.status(200);
        return "";
    }

    // Filters per item
    public Object findByItemId(Request request, Response response) {
        long id = ValidationUtil.validateParamFormat(":id", request.params(":id"), Long.class);
        return this.gson.toJson(this.offerService.findByItemId(id));
    }

    public Object findByItemIdAndActive(Request request, Response response) {
        long itemId = ValidationUtil.validateParamFormat(":itemId", request.params(":itemId"), Long.class);
        return this.gson.toJson(this.offerService.findByItemIdAndStatus(itemId, OfferStatus.OPEN));
    }

    // Filters per user
    public Object findByUserId(Request request, Response response) {
        long userId = ValidationUtil.validateParamFormat(":userId", request.params(":userId"), Long.class);
        return this.gson.toJson(this.offerService.findByUserId(userId));
    }

    public Object findByUserIdAndActive(Request request, Response response) {
        long userId = ValidationUtil.validateParamFormat(":userId", request.params(":userId"), Long.class);
        return this.gson.toJson(this.offerService.findByUserIdAndStatus(userId, OfferStatus.OPEN));
    }

    // Filter per status
    public Object findByStatus(Request request, Response response) {
        String statusParam = request.params(":status").toUpperCase();

        ValidationUtil.validateParamFormat(":status", statusParam, OfferStatus.class);

        OfferStatus status;
        try {
            status = OfferStatus.valueOf(statusParam);
        } catch (IllegalArgumentException e) {
            throw new ValidationException("Invalid status. Valid values: OPEN, ACCEPTED, REJECTED, COMPLETED, CANCELLED");
        }

        return this.gson.toJson(this.offerService.findByStatus(status));
    }

    // Status changes
    public Object acceptOffer(Request request, Response response) {
        long id = ValidationUtil.validateParamFormat(":id", request.params(":id"), Long.class);
        return this.offerService.acceptOffer(id);
    }

    public Object rejectOffer(Request request, Response response) {
        long id = ValidationUtil.validateParamFormat(":id", request.params(":id"), Long.class);
        return this.offerService.rejectOffer(id);
    }

    public Object completeOffer(Request request, Response response) {
        long id = ValidationUtil.validateParamFormat(":id", request.params(":id"), Long.class);
        return this.offerService.completeOffer(id);
    }

    public Object cancelOffer(Request request, Response response) {
        long id = ValidationUtil.validateParamFormat(":id", request.params(":id"), Long.class);
        return this.offerService.cancelOffer(id);
    }

    public Object updateAmount(Request request, Response response) {
        long id = ValidationUtil.validateParamFormat(":id", request.params(":id"), Long.class);
        ValidationUtil.validateNotEmptyBody(request.body());
        return this.offerService.updateAmount(id, gson.fromJson(request.body(), OfferRebidDto.class));
    }
}
package com.pikolinc.controllers.api;

import com.google.gson.Gson;
import com.pikolinc.dto.request.UserCreateDto;
import com.pikolinc.services.UserService;
import com.pikolinc.util.ValidationUtil;
import spark.Request;
import spark.Response;

public class UserApiController {
    private final UserService userService;
    private final Gson gson;

    public UserApiController(UserService userService) {
        this.gson = new Gson();
        this.userService = userService;
    }

    public Object findAll(Request request, Response response) {
        return this.gson.toJson(this.userService.findAll());
    }

    public Object findById(Request request, Response response) {
        return this.gson.toJson(this.userService.findById(Long.parseLong(request.params(":id"))));
    }

    public long insert(Request request, Response response) {
        ValidationUtil.validateNotEmptyBody(request.body());
        return this.userService.insert(gson.fromJson(request.body(), UserCreateDto.class));
    }

    public long update(Request request, Response response) {
        ValidationUtil.validateNotEmptyBody(request.body());
        long id = ValidationUtil.validateParamFormat(":id", request.params(":id"), Long.class);
        return this.userService.update(id, gson.fromJson(request.body(), UserCreateDto.class));
    }

    public long delete(Request request, Response response) {
        long id =  ValidationUtil.validateParamFormat(":id", request.params(":id"), Long.class);
        return this.userService.delete(id);
    }

    public Object options(Request request, Response response) {
        long id = ValidationUtil.validateParamFormat(":id", request.params(":id"), Long.class);
        return gson.toJson(this.userService.options(id));
    }
}
package com.pikolinc.dao;

import com.pikolinc.domain.Item;
import org.jdbi.v3.sqlobject.config.RegisterBeanMapper;
import org.jdbi.v3.sqlobject.customizer.Bind;
import org.jdbi.v3.sqlobject.customizer.BindBean;
import org.jdbi.v3.sqlobject.statement.GetGeneratedKeys;
import org.jdbi.v3.sqlobject.statement.SqlQuery;
import org.jdbi.v3.sqlobject.statement.SqlUpdate;

import java.util.List;
import java.util.Optional;

@RegisterBeanMapper(Item.class)
public interface ItemDao {

    @SqlUpdate("""
                CREATE TABLE IF NOT EXISTS items (
                    id BIGINT AUTO_INCREMENT PRIMARY KEY,
                    name VARCHAR(255) NOT NULL,
                    description TEXT,
                    price DECIMAL(10, 2) NOT NULL
                )
            """)
    void createTable();


    @SqlUpdate("""
        INSERT INTO items (name, description, price) VALUES
        ('Laptop', 'High-performance laptop with 16GB RAM and 512GB SSD', 1299.99),
        ('Smartphone', 'Latest model with 5G support and 128GB storage', 899.99),
        ('Wireless Headphones', 'Noise-cancelling over-ear headphones with 30-hour battery', 249.99),
        ('Gaming Console', 'Next-gen gaming console with 4K graphics', 499.99),
        ('Smartwatch', 'Fitness tracker with heart rate monitor and GPS', 349.99)
    """)
    void insertSampleData();

    @SqlUpdate("INSERT INTO items (name, description, price) VALUES (:name, :description, :price)")
    @GetGeneratedKeys
    long insert(@BindBean Item item);

    @SqlQuery("SELECT * FROM items")
    List<Item> findAll();

    @SqlQuery("SELECT * FROM items WHERE id = :id")
    Optional<Item> findById(@Bind("id") Long id);

    @SqlUpdate("UPDATE items SET name = :name, description = :description, price = :price WHERE id = :id")
    long update(@BindBean Item item);

    @SqlUpdate("DELETE FROM items WHERE id = :id")
    long deleteById(@Bind("id") Long id);
}
package com.pikolinc.dao;

import com.pikolinc.domain.Offer;
import com.pikolinc.dto.response.OfferResponseDto;
import org.jdbi.v3.sqlobject.config.RegisterBeanMapper;
import org.jdbi.v3.sqlobject.customizer.Bind;
import org.jdbi.v3.sqlobject.customizer.BindBean;
import org.jdbi.v3.sqlobject.statement.GetGeneratedKeys;
import org.jdbi.v3.sqlobject.statement.SqlQuery;
import org.jdbi.v3.sqlobject.statement.SqlUpdate;

import java.util.List;
import java.util.Optional;

@RegisterBeanMapper(OfferResponseDto.class)
public interface OfferDao {
    @SqlUpdate("""
                CREATE TABLE IF NOT EXISTS offers (
                    id BIGINT AUTO_INCREMENT PRIMARY KEY,
                    user_id BIGINT NOT NULL,
                    item_id BIGINT NOT NULL,
                    amount DECIMAL(10, 2) NOT NULL CHECK (amount > 0),
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    status VARCHAR(255) DEFAULT 'OPEN',
                    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
                    FOREIGN KEY (item_id) REFERENCES items(id) ON DELETE CASCADE
                )
            """)
    void createTable();

    @SqlUpdate("INSERT INTO offers (user_id, item_id, amount) VALUES (:userId, :itemId, :amount)")
    @GetGeneratedKeys
    long insert(@BindBean Offer offer);

    @SqlQuery("""
        SELECT
            o.id,
            o.user_id AS userId,
            u.name AS userName,
            u.email AS userEmail,
            o.item_id AS itemId,
            i.name AS itemName,
            i.description AS itemDescription,
            i.price AS itemPrice,
            o.amount,
            o.created_at AS createdAt,
            o.status
        FROM offers o
        INNER JOIN users u ON o.user_id = u.id
        INNER JOIN items i ON o.item_id = i.id
        WHERE o.id = :id
    """)
    Optional<OfferResponseDto> findById(@Bind("id") Long id);

    @SqlUpdate("UPDATE offers SET user_id = :userId, item_id = :itemId, amount = :amount, status = :status WHERE id = :id")
    long update(@BindBean Offer offer);

    @SqlQuery("""
        SELECT 
            o.id,
            o.user_id AS userId,
            u.name AS userName,
            u.email AS userEmail,
            o.item_id AS itemId,
            i.name AS itemName,
            i.description AS itemDescription,
            i.price AS itemPrice,
            o.amount,
            o.created_at AS createdAt,
            o.status
        FROM offers o
        INNER JOIN users u ON o.user_id = u.id
        INNER JOIN items i ON o.item_id = i.id
        WHERE o.item_id = :itemId
        ORDER BY o.amount DESC
    """)
    List<OfferResponseDto> findByItemId(@Bind("itemId") Long itemId);

    @SqlQuery("""
        SELECT 
            o.id,
            o.user_id AS userId,
            u.name AS userName,
            u.email AS userEmail,
            o.item_id AS itemId,
            i.name AS itemName,
            i.description AS itemDescription,
            i.price AS itemPrice,
            o.amount,
            o.created_at AS createdAt,
            o.status
        FROM offers o
        INNER JOIN users u ON o.user_id = u.id
        INNER JOIN items i ON o.item_id = i.id
        WHERE o.user_id = :userId
    """)
    List<OfferResponseDto> findByUserId(@Bind("userId") Long userId);

    @SqlQuery("""
        SELECT 
            o.id,
            o.user_id AS userId,
            u.name AS userName,
            u.email AS userEmail,
            o.item_id AS itemId,
            i.name AS itemName,
            i.description AS itemDescription,
            i.price AS itemPrice,
            o.amount,
            o.created_at AS createdAt,
            o.status
        FROM offers o
        INNER JOIN users u ON o.user_id = u.id
        INNER JOIN items i ON o.item_id = i.id
    """)
    List<OfferResponseDto> findAll();

    @SqlUpdate("DELETE FROM offers WHERE id = :id")
    long deleteById(@Bind("id") Long id);

    @SqlUpdate("UPDATE offers SET amount = :amount WHERE id = :id")
    long updateAmount(@Bind("id") Long id, @Bind("amount") Double amount);

    @SqlQuery("""
        SELECT 
            o.id,
            o.user_id AS userId,
            u.name AS userName,
            u.email AS userEmail,
            o.item_id AS itemId,
            i.name AS itemName,
            i.description AS itemDescription,
            i.price AS itemPrice,
            o.amount,
            o.created_at AS createdAt,
            o.status
        FROM offers o
        INNER JOIN users u ON o.user_id = u.id
        INNER JOIN items i ON o.item_id = i.id
        WHERE o.item_id = :itemId AND o.status = :status
        ORDER BY o.amount DESC
    """)
    List<OfferResponseDto> findByItemIdAndStatus(@Bind("itemId") Long itemId, @Bind("status") String status);

    @SqlQuery("""
        SELECT 
            o.id,
            o.user_id AS userId,
            u.name AS userName,
            u.email AS userEmail,
            o.item_id AS itemId,
            i.name AS itemName,
            i.description AS itemDescription,
            i.price AS itemPrice,
            o.amount,
            o.created_at AS createdAt,
            o.status
        FROM offers o
        INNER JOIN users u ON o.user_id = u.id
        INNER JOIN items i ON o.item_id = i.id
        WHERE o.user_id = :userId AND o.status = :status
    """)
    List<OfferResponseDto> findByUserIdAndStatus(@Bind("userId") Long userId, @Bind("status") String status);

    @SqlQuery("""
        SELECT 
            o.id,
            o.user_id AS userId,
            u.name AS userName,
            u.email AS userEmail,
            o.item_id AS itemId,
            i.name AS itemName,
            i.description AS itemDescription,
            i.price AS itemPrice,
            o.amount,
            o.created_at AS createdAt,
            o.status
        FROM offers o
        INNER JOIN users u ON o.user_id = u.id
        INNER JOIN items i ON o.item_id = i.id
        WHERE o.status = :status
    """)
    List<OfferResponseDto> findByStatus(@Bind("status") String status);

    @SqlUpdate("UPDATE offers SET status = :status WHERE id = :id")
    long updateStatus(@Bind("id") Long id, @Bind("status") String status);
}
package com.pikolinc.dao;

import com.pikolinc.domain.User;
import org.jdbi.v3.sqlobject.config.RegisterBeanMapper;
import org.jdbi.v3.sqlobject.customizer.Bind;
import org.jdbi.v3.sqlobject.customizer.BindBean;
import org.jdbi.v3.sqlobject.statement.GetGeneratedKeys;
import org.jdbi.v3.sqlobject.statement.SqlQuery;
import org.jdbi.v3.sqlobject.statement.SqlUpdate;

import java.util.List;
import java.util.Optional;

@RegisterBeanMapper(User.class)
public interface UserDao {
    @SqlUpdate("""
                CREATE TABLE IF NOT EXISTS users (
                    id BIGINT AUTO_INCREMENT PRIMARY KEY,
                    name VARCHAR(255) NOT NULL,
                    email VARCHAR(255) UNIQUE NOT NULL,
                    age INT
                )
            """)
    void createTable();

    @SqlUpdate("""
        INSERT INTO users (name, email, age) VALUES
        ('John Doe', 'john.doe@example.com', 28),
        ('Jane Smith', 'jane.smith@example.com', 34),
        ('Mike Johnson', 'mike.johnson@example.com', 42),
        ('Sarah Williams', 'sarah.williams@example.com', 25),
        ('David Brown', 'david.brown@example.com', 31)
    """)
    void insertSampleData();



    @SqlUpdate("INSERT INTO users (name, email, age) VALUES (:name, :email, :age)")
    @GetGeneratedKeys
    long insert(@BindBean User user);

    @SqlQuery("SELECT * FROM users")
    List<User> findAll();

    @SqlQuery("SELECT * FROM users WHERE id = :id")
    Optional<User> findById(@Bind("id") Long id);

    @SqlUpdate("UPDATE users SET name = :name, email = :email, age = :age WHERE id = :id")
    long update(@BindBean User user);

    @SqlUpdate("DELETE FROM users WHERE id = :id")
    long deleteById(@Bind("id") Long id);

    @SqlQuery("SELECT COUNT(*) > 0 FROM users WHERE email = :email")
    boolean existsByEmail(@Bind("email") String email);
}


package com.pikolinc.domain;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class Item {
    private Long id;
    private String name;
    private String description;
    private Double price;
}
package com.pikolinc.domain;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;

import java.sql.Timestamp;

@Data
@Builder
@AllArgsConstructor
public class Offer {
    private Long id;
    private Long userId;
    private Long itemId;
    private Double amount;
    private OfferStatus status;
    private Timestamp createdAt;

    public Offer() {
        this.status = OfferStatus.OPEN;
    }
}
package com.pikolinc.domain;

public enum OfferStatus {
    OPEN("Open", "Offer is active and awaiting response"),
    ACCEPTED("Accepted", "Offer has been accepted"),
    REJECTED("Rejected", "Offer has been rejected"),
    COMPLETED("Completed", "Transaction has been completed"),
    CANCELLED("Cancelled", "Offer has been cancelled");

    private final String displayName;
    private final String description;

    OfferStatus(String displayName, String description) {
        this.displayName = displayName;
        this.description = description;
    }

    public String getDisplayName() {
        return displayName;
    }

    public String getDescription() {
        return description;
    }

    public boolean isActive() {
        return this == OPEN;
    }

    public boolean isFinal() {
        return this == ACCEPTED || this == REJECTED ||
                this == COMPLETED || this == CANCELLED;
    }
}
package com.pikolinc.domain;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class User {
    private Long id;
    private String name;
    private String email;
    private Integer age;
}
package com.pikolinc.dto.request;

import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.NotNull;
import jakarta.validation.constraints.Positive;
import jakarta.validation.constraints.Size;

public record ItemCreateDto(
        @NotBlank(message = "Name is required")
        @Size(max = 100, message = "Name must not exceed 100 characters")
        String name,

        @Size(max = 500, message = "Description must not exceed 500 characters")
        String description,

        @NotNull(message = "Price is required")
        @Positive(message = "Price must be greater than zero")
        Double price

) {
}
package com.pikolinc.dto.request;

import jakarta.validation.constraints.NotNull;
import jakarta.validation.constraints.Positive;

public record OfferCreateDto(
        @NotNull(message = "User ID is required")
        Long userId,

        @NotNull(message = "Item ID is required")
        Long itemId,
        @NotNull(message = "Final price is required")
        @Positive(message = "Final price must be greater than zero")
        Double finalPrice
) {
}
package com.pikolinc.dto.request;

import jakarta.validation.constraints.NotNull;
import jakarta.validation.constraints.Positive;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@AllArgsConstructor
@NoArgsConstructor
public class OfferRebidDto {
    @NotNull(message = "amount is required")
    @Positive(message = "amount has to be positive")
    private Double amount;
}
package com.pikolinc.dto.request;

import com.pikolinc.domain.OfferStatus;
import jakarta.validation.constraints.DecimalMin;
import jakarta.validation.constraints.NotNull;
import jakarta.validation.constraints.Positive;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@NoArgsConstructor
@AllArgsConstructor
public class OfferUpdateDto {
    @NotNull(message = "User ID is required")
    @Positive(message = "User ID must be positive")
    private Long userId;

    @NotNull(message = "Item ID is required")
    @Positive(message = "Item ID must be positive")
    private Long itemId;

    @NotNull(message = "Amount is required")
    @DecimalMin(value = "0.01", message = "Amount must be greater than 0")
    private Double amount;

    @NotNull(message = "Status is required")
    private OfferStatus status;
}
package com.pikolinc.dto.request;

import jakarta.validation.constraints.*;

public record UserCreateDto(
        @NotBlank(message = "Name is required")
        @Size(min = 2, max = 100, message = "Name must be between 2 and 100 characters")
        @Pattern(regexp = "^[a-zA-ZÃ€-Ã¿\\s'-]+$", message = "Name must contain only letters, spaces, hyphens and apostrophes")
        String name,

        @NotNull(message = "Age is required")
        @Min(value = 18, message = "Age must be at least 18")
        Integer age,

        @NotBlank(message = "Email is required")
        @Email(message = "Email must be valid")
        @Size(max = 255, message = "Email must not exceed 255 characters")
        String email
) {
}
package com.pikolinc.dto.response;

import com.pikolinc.domain.OfferStatus;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.sql.Timestamp;

@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class OfferResponseDto {
    private Long id;
    private Long userId;
    private String userName;
    private String userEmail;
    private Long itemId;
    private String itemName;
    private String itemDescription;
    private Double itemPrice;
    private Double amount;
    private Timestamp createdAt;
    private OfferStatus status;
}
package com.pikolinc.exceptions;

import jakarta.validation.ConstraintViolation;
import lombok.Getter;

import java.util.List;
import java.util.Set;
import java.util.stream.Collectors;

@Getter
public class ValidationException extends RuntimeException {
    private final List<String> errors;

    public ValidationException(Set<? extends ConstraintViolation<?>> violations) {
        super("Validation failed");
        this.errors = violations.stream()
                .map(v -> v.getPropertyPath() + ": " + v.getMessage())
                .collect(Collectors.toList());
    }

    public ValidationException(String message) {
        super(message);
        this.errors = List.of(message);
    }
}



package com.pikolinc.exceptions.api;

public class ApiResourceNotFoundException extends RuntimeException {
    public ApiResourceNotFoundException(String message) {
        super(message);
    }

    public ApiResourceNotFoundException(String resource, Long id) {
        super(String.format("%s not found with id: %d", resource, id));
    }

    public ApiResourceNotFoundException(String resource, String field, String value) {
        super(String.format("%s not found with %s: %s", resource, field, value));
    }
}
package com.pikolinc.exceptions.api;

public class DuplicateResourceException extends RuntimeException {
    public DuplicateResourceException(String message) {
        super(message);
    }

    public DuplicateResourceException(String resource, String field, String value) {
        super(String.format("%s already exists with %s: %s", resource, field, value));
    }
}
package com.pikolinc.infraestructure.events;

import lombok.Getter;

@Getter
public abstract class Event<T> {
    private final T payload;

    public Event(T payload) {
        this.payload = payload;
    }

    public abstract EventType getType();
}
package com.pikolinc.infraestructure.events;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;
import java.util.function.Consumer;

public class EventBus {
    private static final Map<EventType, List<EventListener<?>>> listeners = new ConcurrentHashMap<>();

    private static <T> void registerListener(EventType type, EventListener<T> listener) {
        listeners.computeIfAbsent(type, k -> new ArrayList<>()).add(listener);
    }

    public static <T> void subscribe(EventType eventType, Class<T> clazz, Consumer<T> consumer) {
        registerListener(eventType, obj -> {
            if (!clazz.isInstance(obj)) {
                throw new IllegalArgumentException(
                        "Invalid event type for " + eventType + ". Expected " + clazz.getSimpleName()
                );
            }
            consumer.accept(clazz.cast(obj));
        });
    }

    public static <T> void publish(Event<T> event) {
        List<EventListener<?>> ls = listeners.get(event.getType());
        if (ls == null) return;

        for (EventListener<?> listener : ls) {
            ((EventListener<T>) listener).handle(event.getPayload());
        }
    }

    public interface EventListener<T> {
        void handle(T payload);
    }
}
package com.pikolinc.infraestructure.events;

public enum EventType {
    OFFER_CREATED,
    OFFER_REBID,
    OFFER_UPDATED,
    OFFER_ACCEPTED,
    OFFER_COMPLETED,
    OFFER_CANCELLED,
    OFFER_REJECTED,
    OFFER_DELETED,
    ITEM_CREATED,
    ITEM_UPDATED,
    ITEM_DELETED,
}
package com.pikolinc.infraestructure.events.item;

import com.pikolinc.domain.Item;
import com.pikolinc.infraestructure.events.Event;
import com.pikolinc.infraestructure.events.EventType;

public class ItemCreatedEvent extends Event<Item> {
    public ItemCreatedEvent(Item payload) {
        super(payload);
    }

    @Override
    public EventType getType() {
        return EventType.ITEM_CREATED;
    }
}
package com.pikolinc.infraestructure.events.item;

import com.pikolinc.infraestructure.events.Event;
import com.pikolinc.infraestructure.events.EventType;

public class ItemDeletedEvent extends Event<Long> {
    public ItemDeletedEvent(long payload) {
        super(payload);
    }

    @Override
    public EventType getType() {
        return EventType.ITEM_DELETED;
    }
}
package com.pikolinc.infraestructure.events.item;

import com.pikolinc.domain.Item;
import com.pikolinc.infraestructure.events.Event;
import com.pikolinc.infraestructure.events.EventType;

public class ItemUpdatedEvent extends Event<Item> {
    public ItemUpdatedEvent(Item payload) {
        super(payload);
    }

    @Override
    public EventType getType() {
        return EventType.ITEM_UPDATED;
    }
}
package com.pikolinc.infraestructure.events.listeners;

public interface EventListener {
    void listen();
}
package com.pikolinc.infraestructure.events.listeners;

import com.pikolinc.domain.Item;
import com.pikolinc.infraestructure.events.EventBus;
import com.pikolinc.infraestructure.events.EventType;
import com.pikolinc.ws.ItemListWebsocketHandler;

import java.util.Map;

public class ItemsEventListener implements EventListener {

    @Override
    public void listen() {
        Map<EventType, Class<?>> eventMappings = Map.of(
                EventType.ITEM_CREATED, Item.class,
                EventType.ITEM_UPDATED, Item.class,
                EventType.ITEM_DELETED, Long.class
        );

        eventMappings.forEach((type, clazz) -> {
            if (clazz.equals(Item.class)) {
                EventBus.subscribe(type, Item.class, item -> {
                    // Notify item-specific subscribers
                    ItemListWebsocketHandler.broadcastMessage(type, item.getId().toString(), item);

                    // Notify everyone globally when created or updated
                    if (type == EventType.ITEM_CREATED || type == EventType.ITEM_UPDATED) {
                        ItemListWebsocketHandler.broadcastGlobal(type, item);
                    }
                });
            } else if (clazz.equals(Long.class)) {
                EventBus.subscribe(type, Long.class, id -> {
                    // Notify item-specific subscribers
                    ItemListWebsocketHandler.broadcastMessage(type, String.valueOf(id), id);

                    // Notify everyone globally so UI can remove it
                    ItemListWebsocketHandler.broadcastGlobal(EventType.ITEM_DELETED, id);
                });
            }
        });
    }
}
package com.pikolinc.infraestructure.events.listeners;

import com.pikolinc.dto.response.OfferResponseDto;
import com.pikolinc.infraestructure.events.EventBus;
import com.pikolinc.infraestructure.events.EventType;
import com.pikolinc.services.OfferService;
import com.pikolinc.services.impl.ItemServiceImpl;
import com.pikolinc.services.impl.OfferServiceImpl;
import com.pikolinc.services.impl.UserServiceImpl;
import com.pikolinc.ws.OfferWebSocketHandler;

import java.util.Map;

public class OffersEventListener implements EventListener {
    private final OfferService offerService = new OfferServiceImpl(new ItemServiceImpl(), new UserServiceImpl());

    @Override
    public void listen() {
        Map<EventType, Class<?>> eventMappings = Map.ofEntries(
                Map.entry(EventType.OFFER_CREATED, OfferResponseDto.class),
                Map.entry(EventType.OFFER_UPDATED, OfferResponseDto.class),
                Map.entry(EventType.OFFER_REBID, OfferResponseDto.class),
                Map.entry(EventType.OFFER_ACCEPTED, Long.class),
                Map.entry(EventType.OFFER_COMPLETED, Long.class),
                Map.entry(EventType.OFFER_CANCELLED, Long.class),
                Map.entry(EventType.OFFER_REJECTED, Long.class),
                Map.entry(EventType.OFFER_DELETED, Long.class)
        );

        eventMappings.forEach((type, clazz) -> {
            if (clazz.equals(OfferResponseDto.class)) {
                EventBus.subscribe(type, OfferResponseDto.class,
                        offer -> OfferWebSocketHandler.broadCastMessage(type, offer.getItemId().toString(), offer));
            } else if (clazz.equals(Long.class)) {
                EventBus.subscribe(type, Long.class,
                        id -> {
                            OfferResponseDto offer = offerService.findById(id);
                            OfferWebSocketHandler.broadCastMessage(type, offer.getItemId().toString(), offer);
                        });
            }
        });
    }
}
package com.pikolinc.infraestructure.events.offer;

import com.pikolinc.infraestructure.events.Event;
import com.pikolinc.infraestructure.events.EventType;

public class OfferAcceptedEvent extends Event<Long> {
    public OfferAcceptedEvent(Long payload) {
        super(payload);
    }

    @Override
    public EventType getType() {
        return EventType.OFFER_ACCEPTED;
    }
}
package com.pikolinc.infraestructure.events.offer;

import com.pikolinc.infraestructure.events.Event;
import com.pikolinc.infraestructure.events.EventType;

public class OfferCancelledEvent extends Event<Long> {
    public OfferCancelledEvent(Long payload) {
        super(payload);
    }

    @Override
    public EventType getType() {
        return EventType.OFFER_CANCELLED;
    }
}
package com.pikolinc.infraestructure.events.offer;

import com.pikolinc.infraestructure.events.Event;
import com.pikolinc.infraestructure.events.EventType;

public class OfferCompletedEvent extends Event<Long> {
    public OfferCompletedEvent(Long payload) {
        super(payload);
    }

    @Override
    public EventType getType() {
        return EventType.OFFER_COMPLETED;
    }
}
package com.pikolinc.infraestructure.events.offer;

import com.pikolinc.dto.response.OfferResponseDto;
import com.pikolinc.infraestructure.events.Event;
import com.pikolinc.infraestructure.events.EventType;

public class OfferCreatedEvent extends Event<OfferResponseDto> {
    public OfferCreatedEvent(OfferResponseDto payload) {
        super(payload);
    }

    @Override
    public EventType getType() {
        return EventType.OFFER_CREATED;
    }
}
package com.pikolinc.infraestructure.events.offer;

import com.pikolinc.infraestructure.events.Event;
import com.pikolinc.infraestructure.events.EventType;

public class OfferDeletedEvent extends Event<Long> {
    public OfferDeletedEvent(Long payload) {
        super(payload);
    }

    @Override
    public EventType getType() {
        return EventType.OFFER_DELETED;
    }
}
package com.pikolinc.infraestructure.events.offer;

import com.pikolinc.dto.response.OfferResponseDto;
import com.pikolinc.infraestructure.events.Event;
import com.pikolinc.infraestructure.events.EventType;

public class OfferRebidEvent extends Event<OfferResponseDto> {
    public OfferRebidEvent(OfferResponseDto payload) {
        super(payload);
    }

    @Override
    public EventType getType() {
        return EventType.OFFER_REBID;
    }
}
package com.pikolinc.infraestructure.events.offer;

import com.pikolinc.infraestructure.events.Event;
import com.pikolinc.infraestructure.events.EventType;

public class OfferRejectedEvent extends Event<Long> {
    public OfferRejectedEvent(Long payload) {
        super(payload);
    }

    @Override
    public EventType getType() {
        return
                EventType.OFFER_REJECTED;
    }
}
package com.pikolinc.infraestructure.events.offer;

import com.pikolinc.dto.response.OfferResponseDto;
import com.pikolinc.infraestructure.events.Event;
import com.pikolinc.infraestructure.events.EventType;

public class OfferUpdatedEvent extends Event<OfferResponseDto> {
    public OfferUpdatedEvent(OfferResponseDto payload) {
        super(payload);
    }

    @Override
    public EventType getType() {
        return EventType.OFFER_UPDATED;
    }
}
package com.pikolinc.routes.api;

import com.pikolinc.controllers.api.ItemApiController;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import spark.Spark;

public class ItemApiRouter implements Router {
    private static final Logger logger = LoggerFactory.getLogger(ItemApiRouter.class);
    private final ItemApiController itemController;

    public ItemApiRouter(ItemApiController itemController) {
        this.itemController = itemController;
    }

    @Override
    public void registerRoutes() {
        logger.info("Registering routes for ItemApiController");

        Spark.path("/api/v1", () -> {
            Spark.get("/items", itemController::findAll);
            Spark.get("/items/:id", itemController::findById);
            Spark.post("/items", itemController::insert);
            Spark.put("/items/:id", itemController::update);
            Spark.options("/items/:id", itemController::options);
            Spark.delete("/items/:id", itemController::delete);
        });
    }
}
package com.pikolinc.routes.api;

import com.pikolinc.controllers.api.OfferApiController;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import spark.Spark;

public class OfferApiRouter implements Router {
    private static final Logger logger = LoggerFactory.getLogger(OfferApiRouter.class);
    private final OfferApiController offerController;

    public OfferApiRouter(OfferApiController offerController) {
        this.offerController = offerController;
    }

    @Override
    public void registerRoutes() {
        logger.info("Registering routes for OfferApiController");

        Spark.path("/api/v1", () -> {
            // Basic operations
            Spark.get("/offers", offerController::findAll);
            Spark.get("/offers/:id", offerController::findById);
            Spark.post("/offers", offerController::insert);
            Spark.put("/offers/:id", offerController::update);
            Spark.delete("/offers/:id", offerController::delete);

            // Filters per item
            Spark.get("/offers/item/:itemId", offerController::findByItemId);
            Spark.get("/offers/item/:itemId/active", offerController::findByItemIdAndActive);

            // Filters per user
            Spark.get("/offers/user/:userId", offerController::findByUserId);
            Spark.get("/offers/user/:userId/active", offerController::findByUserIdAndActive);

            // Filter per status
            Spark.get("/offers/status/:status", offerController::findByStatus);

            // Status changes
            Spark.put("/offers/:id/accept", offerController::acceptOffer);
            Spark.put("/offers/:id/reject", offerController::rejectOffer);
            Spark.put("/offers/:id/complete", offerController::completeOffer);
            Spark.put("/offers/:id/cancel", offerController::cancelOffer);

            // Rebid
            Spark.patch("/offers/:id/amount", offerController::updateAmount);
        });
    }
}
package com.pikolinc.routes.api;

public interface Router {
    void registerRoutes();
}
package com.pikolinc.routes.api;

import com.pikolinc.controllers.api.UserApiController;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import spark.Spark;

public class UserApiRouter implements Router {
    private static final Logger logger = LoggerFactory.getLogger(UserApiRouter.class);
    private final UserApiController userController;

    public UserApiRouter(UserApiController userController) {
        this.userController = userController;
    }

    @Override
    public void registerRoutes() {
        logger.info("Registering routes for UserApiController");
        Spark.path("/api/v1", () -> {
            Spark.get("/users", userController::findAll);
            Spark.get("/users/:id", userController::findById);
            Spark.post("/users", userController::insert);
            Spark.put("/users/:id", userController::update);
            Spark.options("/users/:id", userController::options);
            Spark.delete("/users/:id", userController::delete);
        });
    }
}
package com.pikolinc.routes.web;

import com.pikolinc.routes.api.Router;
import com.pikolinc.services.ItemService;
import com.pikolinc.services.OfferService;
import com.pikolinc.services.UserService;
import com.pikolinc.services.impl.ItemServiceImpl;
import com.pikolinc.services.impl.OfferServiceImpl;
import com.pikolinc.services.impl.UserServiceImpl;
import spark.ModelAndView;
import spark.Spark;
import spark.template.mustache.MustacheTemplateEngine;

import java.util.HashMap;
import java.util.Map;

public class WebRouter implements Router {
    private static final MustacheTemplateEngine mustache = new MustacheTemplateEngine();
    private final ItemService itemService = new ItemServiceImpl();
    private final UserService userService = new UserServiceImpl();
    private final OfferService offerService = new OfferServiceImpl(itemService, userService);

    @Override
    public void registerRoutes() {
        Spark.get("/", (req, res) -> {
            Map<String, Object> model = new HashMap<>();
            model.put("items", itemService.findAll());
            return new ModelAndView(model, "index.mustache");
        }, mustache);

        Spark.get("/items/:id/offers", (req, res) -> {
            long itemId = Long.parseLong(req.params("id"));
            Map<String, Object> model = new HashMap<>();
            model.put("item", itemService.findById(itemId));
            model.put("offers", offerService.findByItemId(itemId));
            return new ModelAndView(model, "offer.mustache");
        }, mustache);
    }
}
package com.pikolinc.services;

import com.pikolinc.domain.Item;
import com.pikolinc.dto.request.ItemCreateDto;

import java.util.List;

public interface ItemService {
    long insert(ItemCreateDto dto);
    List<Item> findAll();
    Item findById(long id);
    long update(long id, ItemCreateDto dto);
    long delete(long id);
    Object options(long id);
}
package com.pikolinc.services;


import com.pikolinc.domain.Offer;
import com.pikolinc.domain.OfferStatus;
import com.pikolinc.dto.request.OfferCreateDto;
import com.pikolinc.dto.request.OfferRebidDto;
import com.pikolinc.dto.request.OfferUpdateDto;
import com.pikolinc.dto.response.OfferResponseDto;

import java.util.List;

public interface OfferService {
    long insert(OfferCreateDto offerCreateDto);
    List<OfferResponseDto> findAll();
    OfferResponseDto findById(long id);
    long update(long id, OfferUpdateDto offerUpdateDto);
    long delete(long id);

    // Filters
    List<OfferResponseDto> findByItemId(long itemId);
    List<OfferResponseDto> findByItemIdAndStatus(long itemId, OfferStatus status);
    List<OfferResponseDto> findByUserId(long userId);
    List<OfferResponseDto> findByUserIdAndStatus(long userId, OfferStatus status);
    List<OfferResponseDto> findByStatus(OfferStatus status);
    
    // State changes
    long acceptOffer(long id);
    long rejectOffer(long id);
    long completeOffer(long id);
    long cancelOffer(long id);

    // Rebidding if status = OPEN
    long updateAmount(long id, OfferRebidDto offerRebidDto);
}
package com.pikolinc.services;

import com.pikolinc.dto.request.UserCreateDto;
import com.pikolinc.domain.User;

import java.util.List;

public interface UserService {
    long insert(UserCreateDto dto);
    List<User> findAll();
    User findById(long id);
    long update(long id, UserCreateDto dto);
    long delete(long id);
    Object options(long id);
}
package com.pikolinc.services.base;

import com.pikolinc.app.initializer.config.DatabaseInitializer;
import org.jdbi.v3.core.Jdbi;

public class BaseService {
    protected final Jdbi jdbi;

    protected BaseService() {
        this.jdbi = DatabaseInitializer.getJdbi();
    }

    protected <R, D> R withDao(Class<D> daoClass, DaoCallback<R, D> callback) {
        return jdbi.withExtension(daoClass, callback::execute);
    }

    @FunctionalInterface
    protected interface DaoCallback<R, D> {
        R execute(D dao);
    }
}
package com.pikolinc.services.impl;

import com.pikolinc.dao.ItemDao;
import com.pikolinc.dao.UserDao;
import com.pikolinc.domain.Item;
import com.pikolinc.dto.request.ItemCreateDto;
import com.pikolinc.exceptions.api.ApiResourceNotFoundException;
import com.pikolinc.infraestructure.events.EventBus;
import com.pikolinc.infraestructure.events.item.ItemCreatedEvent;
import com.pikolinc.infraestructure.events.item.ItemDeletedEvent;
import com.pikolinc.infraestructure.events.item.ItemUpdatedEvent;
import com.pikolinc.services.ItemService;
import com.pikolinc.services.base.BaseService;
import com.pikolinc.util.ValidationUtil;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.List;
import java.util.Map;


public class ItemServiceImpl extends BaseService implements ItemService {
    private static final Logger logger = LoggerFactory.getLogger(ItemServiceImpl.class);

    @Override
    public long insert(ItemCreateDto dto) {
        ValidationUtil.validate(dto);

        return withDao(ItemDao.class, dao -> {
            Item itemEntity = Item.builder()
                    .name(dto.name())
                    .price(dto.price())
                    .description(dto.description())
                    .build();

            long itemId = dao.insert(itemEntity);

            logger.info("insert item id is {}", itemId);

            itemEntity.setId(itemId);
            EventBus.publish(new ItemCreatedEvent(itemEntity));
            return itemId;
        });
    }

    @Override
    public List<Item> findAll() {
        logger.info("find all items");
        return withDao(ItemDao.class, ItemDao::findAll);
    }

    @Override
    public Item findById(long id) {
        logger.info("find item by id {}", id);

        return withDao(ItemDao.class, dao ->
                dao.findById(id).orElseThrow(() -> {
                    logger.warn("Item not found with id: {}", id);
                    return new ApiResourceNotFoundException("Item", id);
                })
        );
    }

    @Override
    public long update(long id, ItemCreateDto dto) {
        ValidationUtil.validate(dto);

        return withDao(ItemDao.class, dao -> {
            Item existingItem = dao.findById(id).orElseThrow(() -> new ApiResourceNotFoundException("Item", id));

            existingItem.setName(dto.name());
            existingItem.setPrice(dto.price());
            existingItem.setDescription(dto.description());

            long updated = dao.update(existingItem);
            logger.info("Item updated with id: {}", id);

            EventBus.publish(new ItemUpdatedEvent(existingItem));
            return updated;
        });
    }

    @Override
    public long delete(long id) {
        logger.info("Deleting item with id {}", id);

        return withDao(ItemDao.class, dao -> {
            if (dao.findById(id).isEmpty()){
                logger.warn("Attempted to delete non-existent item with id {}", id);
                throw new ApiResourceNotFoundException("Item", id);
            }

            long deleted = dao.deleteById(id);

            logger.info("Item deleted with id: {}", id);

            EventBus.publish(new ItemDeletedEvent(id));
            return deleted;
        });
    }

    @Override
    public Map<String, Boolean> options(long id) {
        logger.info("Checking existence of item with id: {}", id);

        return withDao(UserDao.class, dao -> {
            boolean exists = dao.findById(id).isPresent();
            logger.info("Item with id {} exists: {}", id, exists);
            return Map.of("exists", exists);
        });
    }
}
package com.pikolinc.services.impl;

import com.pikolinc.dao.OfferDao;
import com.pikolinc.domain.Offer;
import com.pikolinc.domain.OfferStatus;
import com.pikolinc.dto.request.OfferCreateDto;
import com.pikolinc.dto.request.OfferRebidDto;
import com.pikolinc.dto.request.OfferUpdateDto;
import com.pikolinc.dto.response.OfferResponseDto;
import com.pikolinc.exceptions.ValidationException;
import com.pikolinc.exceptions.api.ApiResourceNotFoundException;
import com.pikolinc.exceptions.api.DuplicateResourceException;
import com.pikolinc.infraestructure.events.Event;
import com.pikolinc.infraestructure.events.EventBus;
import com.pikolinc.infraestructure.events.EventType;
import com.pikolinc.infraestructure.events.offer.*;
import com.pikolinc.services.ItemService;
import com.pikolinc.services.OfferService;
import com.pikolinc.services.UserService;
import com.pikolinc.services.base.BaseService;
import com.pikolinc.util.ValidationUtil;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.List;

public class OfferServiceImpl extends BaseService implements OfferService {
    private static final Logger logger = LoggerFactory.getLogger(OfferServiceImpl.class);
    private final ItemService itemService;
    private final UserService userService;

    public OfferServiceImpl(ItemService itemService, UserService userService) {
        this.itemService = itemService;
        this.userService = userService;
    }

    @Override
    public long insert(OfferCreateDto offerCreateDto) {
        ValidationUtil.validate(offerCreateDto);

        itemService.findById(offerCreateDto.itemId());
        userService.findById(offerCreateDto.userId());

        return withDao(OfferDao.class, dao -> {
            final List<OfferResponseDto> offersWithSameItemId = dao.findByItemId(offerCreateDto.itemId());

            offersWithSameItemId.forEach(offer -> {
                if (offer.getUserId().equals(offerCreateDto.userId()))
                    throw new DuplicateResourceException("Offer already exists");
            });

            Offer offer = new Offer();
            offer.setUserId(offerCreateDto.userId());
            offer.setItemId(offerCreateDto.itemId());
            offer.setAmount(offerCreateDto.finalPrice());

            long offerId = dao.insert(offer);

            logger.info("Insert offer with id {}", offerId);

            OfferResponseDto offerResponseDto = findById(offerId);

            EventBus.publish(new OfferCreatedEvent(offerResponseDto));
            return offerId;
        });
    }

    @Override
    public List<OfferResponseDto> findAll() {
        logger.info("Find all offers");
        return withDao(OfferDao.class, OfferDao::findAll);
    }

    @Override
    public OfferResponseDto findById(long id) {
        logger.info("Find offer with id {}", id);

        return withDao(OfferDao.class, dao ->
                dao.findById(id).orElseThrow(() -> {
                    logger.warn("Offer with id {} not found", id);
                    return new ApiResourceNotFoundException("Offer", id);
                })
        );
    }

    @Override
    public long update(long id, OfferUpdateDto offerUpdateDto) {
        ValidationUtil.validate(offerUpdateDto);

        return withDao(OfferDao.class, dao -> {
            OfferResponseDto existingOffer = dao.findById(id).orElseThrow(() -> new ApiResourceNotFoundException("Offer", id));

            Offer offer = Offer.builder()
                    .id(existingOffer.getId())
                    .userId(offerUpdateDto.getUserId())
                    .amount(offerUpdateDto.getAmount())
                    .status(offerUpdateDto.getStatus())
                    .build();

            long updated = dao.update(offer);

            EventBus.publish(new OfferUpdatedEvent(findById(id)));
            return updated;
        });
    }

    @Override
    public long delete(long id) {
        logger.info("Deleting offer with id: {}", id);

        return withDao(OfferDao.class, dao -> {
            if (dao.findById(id).isEmpty()) {
                logger.warn("Attempted to delete non-existent offer with id: {}", id);
                throw new ApiResourceNotFoundException("Offer", id);
            }

            EventBus.publish(new OfferDeletedEvent(id));
            long deleted = dao.deleteById(id);

            logger.info("Deleted offer with id: {}", id);

            return deleted;
        });
    }

    @Override
    public List<OfferResponseDto> findByItemId(long itemId) {
        logger.info("Find by offers with item id: {}", itemId);
        return withDao(OfferDao.class, dao -> dao.findByItemId(itemId));
    }

    @Override
    public List<OfferResponseDto> findByItemIdAndStatus(long itemId, OfferStatus status) {
        logger.info("Find offers with item id: {} and status: {}", itemId, status);
        return withDao(OfferDao.class, dao -> dao.findByItemIdAndStatus(itemId, status.name()));
    }

    @Override
    public List<OfferResponseDto> findByUserId(long userId) {
        logger.info("Find offers by user id: {}", userId);
        return withDao(OfferDao.class, dao -> dao.findByUserId(userId));
    }

    @Override
    public List<OfferResponseDto> findByUserIdAndStatus(long userId, OfferStatus status) {
        logger.info("Find offers by user id: {} and status: {}", userId, status);
        return withDao(OfferDao.class, dao -> dao.findByUserIdAndStatus(userId, status.name()));
    }

    @Override
    public List<OfferResponseDto> findByStatus(OfferStatus status) {
        logger.info("Find offers by status: {}", status);
        return withDao(OfferDao.class, dao -> dao.findByStatus(status.name()));
    }

    @Override
    public long acceptOffer(long id) {
        validateOfferStatus(id, OfferStatus.OPEN);
        long result = withDao(OfferDao.class, dao -> dao.updateStatus(id, OfferStatus.ACCEPTED.name()));

        if (result == 1) {
            logger.info("Offer with id {} accepted", id);
            EventBus.publish(new OfferAcceptedEvent(id));
        }
        return result;
    }

    @Override
    public long rejectOffer(long id) {
        validateOfferStatus(id, OfferStatus.OPEN);

        long result = withDao(OfferDao.class, dao -> dao.updateStatus(id, OfferStatus.REJECTED.name()));

        if (result == 1) {
            logger.info("Offer with id {} rejected", id);
            EventBus.publish(new OfferRejectedEvent(id));
        }

        return result;
    }

    @Override
    public long completeOffer(long id) {
        validateOfferStatus(id, OfferStatus.ACCEPTED);

        long result = withDao(OfferDao.class, dao -> dao.updateStatus(id, OfferStatus.COMPLETED.name()));

        if (result == 1) {
            logger.info("Offer with id {} completed", id);
            EventBus.publish(new OfferCompletedEvent(id));
        }

        return result;
    }

    @Override
    public long cancelOffer(long id) {
        OfferResponseDto offer = findById(id);

        if (offer.getStatus() != OfferStatus.OPEN && offer.getStatus() != OfferStatus.ACCEPTED)
            throw new ValidationException("Cannot cancel offer with status: " + offer.getStatus());

        long result = withDao(OfferDao.class, dao -> dao.updateStatus(id, OfferStatus.CANCELLED.name()));

        if (result == 1) {
            logger.info("Offer {} cancelled", id);
            EventBus.publish(new OfferCancelledEvent(id));
        }
        return result;
    }

    @Override
    public long updateAmount(long id, OfferRebidDto rebidDto) {
        ValidationUtil.validate(rebidDto);
        validateOfferStatus(id, OfferStatus.OPEN);

        long result = withDao(OfferDao.class, dao -> dao.updateAmount(id, rebidDto.getAmount()));

        if (result == 1) {
            OfferResponseDto dto = findById(id);
            logger.info("Offer {} rebid to amount {}", id, dto.getAmount());
            EventBus.publish(new OfferRebidEvent(dto));
        }

        return result;
    }

    private void validateOfferStatus(long id, OfferStatus expectedStatus) {
        OfferResponseDto offer = findById(id);

        if (offer.getStatus() != expectedStatus) {
            throw new ValidationException(
                    String.format("Cannot perform this action. Expected status: %s, but found: %s",
                            expectedStatus, offer.getStatus())
            );
        }
    }
}
package com.pikolinc.services.impl;

import com.pikolinc.dao.UserDao;
import com.pikolinc.dto.request.UserCreateDto;
import com.pikolinc.domain.User;
import com.pikolinc.exceptions.api.ApiResourceNotFoundException;
import com.pikolinc.exceptions.api.DuplicateResourceException;
import com.pikolinc.services.UserService;
import com.pikolinc.services.base.BaseService;
import com.pikolinc.util.ValidationUtil;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.List;
import java.util.Map;

public class UserServiceImpl extends BaseService implements UserService {
    private static final Logger logger = LoggerFactory.getLogger(UserServiceImpl.class);

    @Override
    public long insert(UserCreateDto dto) {
        ValidationUtil.validate(dto);

        return withDao(UserDao.class, dao -> {
            if (dao.existsByEmail(dto.email())) {
                logger.warn("Attempted to create user with duplicate email: {}", dto.email());
                throw new DuplicateResourceException("User", "email", dto.email());
            }

            User userEntity = User.builder()
                    .name(dto.name())
                    .email(dto.email())
                    .age(dto.age())
                    .build();

            long userId = dao.insert(userEntity);
            logger.info("User created with id: {}", userId);

            return userId;
        });
    }

    @Override
    public List<User> findAll() {
        logger.info("Finding all users");
        return withDao(UserDao.class, UserDao::findAll);
    }

    @Override
    public User findById(long id) {
        logger.info("Finding user by id: {}", id);

        return withDao(UserDao.class, dao ->
                dao.findById(id).orElseThrow(() -> {
                    logger.warn("User not found with id: {}", id);
                    return new ApiResourceNotFoundException("User", id);
                })
        );
    }

    @Override
    public long update(long id, UserCreateDto dto) {

        ValidationUtil.validate(dto);

        return withDao(UserDao.class, dao -> {
            User existingUser = dao.findById(id)
                    .orElseThrow(() -> new ApiResourceNotFoundException("User", id));

            if (!dto.email().equals(existingUser.getEmail()) &&
                    dao.existsByEmail(dto.email())) {
                logger.warn("Attempted to update user {} with duplicate email: {}", id, dto.email());
                throw new DuplicateResourceException("User", "email", dto.email());
            }

            existingUser.setName(dto.name());
            existingUser.setEmail(dto.email());
            existingUser.setAge(dto.age());

            long updated = dao.update(existingUser);
            logger.info("User updated with id: {}", id);

            return updated;
        });
    }

    @Override
    public long delete(long id) {
        logger.info("Deleting user with id: {}", id);

        return withDao(UserDao.class, dao -> {
            if (dao.findById(id).isEmpty()) {
                logger.warn("Attempted to delete non-existent user with id: {}", id);
                throw new ApiResourceNotFoundException("User", id);
            }

            long deleted = dao.deleteById(id);
            logger.info("User deleted with id: {}", id);

            return deleted;
        });
    }

    @Override
    public Map<String, Boolean> options(long id) {
        logger.info("Checking existence of user with id: {}", id);

        return withDao(UserDao.class, dao -> {
            boolean exists = dao.findById(id).isPresent();
            logger.info("User with id {} exists: {}", id, exists);
            return Map.of("exists", exists);
        });
    }
}
package com.pikolinc.util;

import jakarta.validation.*;
import com.pikolinc.exceptions.ValidationException;

import java.lang.reflect.AccessibleObject;
import java.util.HashMap;
import java.util.Map;
import java.util.Set;
import java.util.UUID;
import java.util.function.Function;

public class ValidationUtil {
    private static final Validator validator;
    private static final Map<Class<?>, Function<String, ?>> PARSERS = new HashMap<>();

    static {
        ValidatorFactory factory = Validation.buildDefaultValidatorFactory();
        validator = factory.getValidator();

        PARSERS.put(Long.class, Long::parseLong);
        PARSERS.put(Integer.class, Integer::parseInt);
        PARSERS.put(Double.class, Double::parseDouble);
        PARSERS.put(Float.class, Float::parseFloat);
        PARSERS.put(UUID.class, UUID::fromString);
        PARSERS.put(String.class, s -> s); // allows simple string params
    }

    /**
     * Validates an object and throws ValidationException if violations exist
     *
     * @param object The object to validate
     * @throws ValidationException if validation fails
     */
    public static <T> void validate(T object) {
        Set<ConstraintViolation<T>> violations = validator.validate(object);
        if (!violations.isEmpty()) {
            throw new ValidationException(violations);
        }
    }

    /**
     * Validates an object with specific validation groups
     *
     * @param object The object to validate
     * @param groups Validation groups to apply
     * @throws ValidationException if validation fails
     */
    public static <T> void validate(T object, Class<?>... groups) {
        Set<ConstraintViolation<T>> violations = validator.validate(object, groups);
        if (!violations.isEmpty()) {
            throw new ValidationException(violations);
        }
    }

    /**
     * Validates a specific property of an object
     *
     * @param object       The object containing the property
     * @param propertyName The property name to validate
     * @throws ValidationException if validation fails
     */
    public static <T> void validateProperty(T object, String propertyName) {
        Set<ConstraintViolation<T>> violations = validator.validateProperty(object, propertyName);
        if (!violations.isEmpty()) {
            throw new ValidationException(violations);
        }
    }

    /**
     * Validates an object and returns true/false without throwing
     *
     * @param object The object to validate
     * @return true if valid, false otherwise
     */
    public static <T> boolean isValid(T object) {
        Set<ConstraintViolation<T>> violations = validator.validate(object);
        return violations.isEmpty();
    }

    /**
     * Gets violations without throwing exception
     *
     * @param object The object to validate
     * @return Set of constraint violations
     */
    public static <T> Set<ConstraintViolation<T>> getViolations(T object) {
        return validator.validate(object);
    }

    /**
     * Checks if the request body is empty or null.
     * This is useful before running bean validation.
     *
     * @param body The request body object (after deserialization)
     * @throws ValidationException if the body is null or has no properties
     */
    public static void validateNotEmptyBody(Object body) {
        if (body == null) {
            throw new ValidationException("Request body cannot be null or empty.");
        }

        // check if it's an empty bean (all fields null)
        boolean allFieldsNull = java.util.Arrays.stream(body.getClass().getDeclaredFields())
                .peek(AccessibleObject::trySetAccessible)
                .allMatch(f -> {
                    try {
                        return f.get(body) == null;
                    } catch (IllegalAccessException e) {
                        return true; // treat inaccessible as null
                    }
                });

        if (allFieldsNull) {
            throw new ValidationException("Request body cannot be empty.");
        }
    }

    /**
     * Validates that a request parameter matches the expected type
     * and returns its parsed value.
     *
     * @param paramName  The name of the parameter (for error messages)
     * @param paramValue The raw string value of the parameter
     * @param type       The expected type (e.g., Long.class, UUID.class)
     * @param <T>        The generic return type
     * @return The parsed value of the given type
     * @throws ValidationException if parsing fails or type is unsupported
     */
    @SuppressWarnings("unchecked")
    public static <T> T validateParamFormat(String paramName, String paramValue, Class<T> type) {
        if (paramValue == null || paramValue.isBlank()) {
            throw new ValidationException("Missing or empty parameter: " + paramName);
        }

        Function<String, ?> parser = PARSERS.get(type);

        if (parser == null) {
            throw new ValidationException("Unsupported parameter type: " + type.getSimpleName());
        }

        try {
            return (T) parser.apply(paramValue);
        } catch (Exception e) {
            throw new ValidationException(
                    "Invalid format for parameter '" + paramName + "': expected " + type.getSimpleName()
            );
        }
    }


}
package com.pikolinc.ws;

import com.google.gson.Gson;
import com.google.gson.JsonObject;
import com.pikolinc.infraestructure.events.EventType;
import com.pikolinc.ws.message.WebSocketMessage;
import org.eclipse.jetty.websocket.api.Session;
import org.eclipse.jetty.websocket.api.annotations.OnWebSocketClose;
import org.eclipse.jetty.websocket.api.annotations.OnWebSocketConnect;
import org.eclipse.jetty.websocket.api.annotations.OnWebSocketMessage;
import org.eclipse.jetty.websocket.api.annotations.WebSocket;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.util.Map;
import java.util.Set;
import java.util.concurrent.ConcurrentHashMap;

@WebSocket
public class ItemListWebsocketHandler {
    private static final Logger logger = LoggerFactory.getLogger(ItemListWebsocketHandler.class);
    private static final Gson gson = new Gson();

    // Sessions subscribed to all global events (e.g., ITEM_CREATED)
    private static final Set<Session> globalSubscribers = ConcurrentHashMap.newKeySet();

    // itemId -> sessions subscribed to that item
    private static final Map<String, Set<Session>> itemSubscriptions = new ConcurrentHashMap<>();

    // session -> itemIds it subscribed to
    private static final Map<Session, Set<String>> sessionSubscriptions = new ConcurrentHashMap<>();

    @OnWebSocketConnect
    public void onConnect(Session session) {
        sessionSubscriptions.put(session, ConcurrentHashMap.newKeySet());
        logger.info("{} Connected to item list", session.getRemoteAddress().getHostName());
    }

    @OnWebSocketMessage
    public void onMessage(Session session, String message) {
        try {
            JsonObject json = gson.fromJson(message, JsonObject.class);
            String action = json.has("action") ? json.get("action").getAsString() : "";

            if ("subscribe".equalsIgnoreCase(action)) {
                json.getAsJsonArray("itemIds").forEach(id -> subscribe(session, id.getAsString()));
            } else if ("unsubscribe".equalsIgnoreCase(action)) {
                json.getAsJsonArray("itemIds").forEach(id -> unsubscribe(session, id.getAsString()));
            } else if ("subscribeAll".equalsIgnoreCase(action)) {
                globalSubscribers.add(session);
                logger.info("{} subscribed to ALL items", session.getRemoteAddress().getHostName());
            } else if ("unsubscribeAll".equalsIgnoreCase(action)) {
                globalSubscribers.remove(session);
                logger.info("{} unsubscribed from ALL items", session.getRemoteAddress().getHostName());
            } else {
                logger.warn("Unknown action from {}: {}", session.getRemoteAddress(), message);
            }
        } catch (Exception e) {
            logger.warn("Failed to handle message from {}: {}", session.getRemoteAddress(), e.getMessage());
        }
    }

    @OnWebSocketClose
    public void onClose(Session session, int statusCode, String reason) {
        // Remove session from item subscriptions
        Set<String> items = sessionSubscriptions.get(session);
        if (items != null) {
            items.forEach(itemId -> {
                Set<Session> sessions = itemSubscriptions.get(itemId);
                if (sessions != null) sessions.remove(session);
            });
        }

        // Remove from globals
        globalSubscribers.remove(session);
        sessionSubscriptions.remove(session);

        logger.info("Disconnected: {} ({})", session.getRemoteAddress(), reason);
    }

    /**
     * Broadcasts a message to all sessions subscribed to a specific item.
     */
    public static void broadcastMessage(EventType eventType, String itemId, Object obj) {
        Set<Session> sessions = itemSubscriptions.get(itemId);
        if (sessions == null || sessions.isEmpty()) return;

        sessions.removeIf(s -> !s.isOpen());

        WebSocketMessage message = WebSocketMessage.builder()
                .eventType(eventType)
                .data(obj)
                .build();

        for (Session s : sessions) {
            try {
                s.getRemote().sendString(gson.toJson(message));
            } catch (IOException e) {
                logger.warn("Failed to send item message to {}: {}", s.getRemoteAddress(), e.getMessage());
            }
        }
    }

    /**
     * Broadcasts a message to all global subscribers (e.g., for ITEM_CREATED).
     */
    public static void broadcastGlobal(EventType eventType, Object obj) {
        if (globalSubscribers.isEmpty()) return;

        globalSubscribers.removeIf(s -> !s.isOpen());

        WebSocketMessage message = WebSocketMessage.builder()
                .eventType(eventType)
                .data(obj)
                .build();

        for (Session s : globalSubscribers) {
            try {
                s.getRemote().sendString(gson.toJson(message));
            } catch (IOException e) {
                logger.warn("Failed to send global event to {}: {}", s.getRemoteAddress(), e.getMessage());
            }
        }
    }

    private void subscribe(Session session, String itemId) {
        itemSubscriptions.computeIfAbsent(itemId, k -> ConcurrentHashMap.newKeySet()).add(session);
        sessionSubscriptions.computeIfAbsent(session, k -> ConcurrentHashMap.newKeySet()).add(itemId);
        logger.info("{} subscribed to item {}", session.getRemoteAddress().getHostName(), itemId);
    }

    private void unsubscribe(Session session, String itemId) {
        Set<Session> sessions = itemSubscriptions.get(itemId);
        if (sessions != null) sessions.remove(session);
        Set<String> items = sessionSubscriptions.get(session);
        if (items != null) items.remove(itemId);
        logger.info("{} unsubscribed from item {}", session.getRemoteAddress().getHostName(), itemId);
    }
}
package com.pikolinc.ws;

import com.google.gson.Gson;
import com.pikolinc.dto.response.OfferResponseDto;
import com.pikolinc.infraestructure.events.EventType;
import com.pikolinc.ws.message.WebSocketMessage;
import org.eclipse.jetty.websocket.api.Session;
import org.eclipse.jetty.websocket.api.annotations.OnWebSocketClose;
import org.eclipse.jetty.websocket.api.annotations.OnWebSocketConnect;
import org.eclipse.jetty.websocket.api.annotations.WebSocket;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.net.URLDecoder;
import java.nio.charset.StandardCharsets;
import java.util.Set;
import java.util.concurrent.ConcurrentHashMap;

@WebSocket
public class OfferWebSocketHandler {
    private static final ConcurrentHashMap<String, Set<Session>> offerSessions = new ConcurrentHashMap<>();
    private static final Logger logger = LoggerFactory.getLogger(OfferWebSocketHandler.class);
    private static final Gson gson = new Gson();

    @OnWebSocketConnect
    public void onConnect(Session session) {
        Long itemId = getItemIdFromQuery(session);

        if (itemId == null) {
            logger.warn("Connection rejected, missing itemId: {}", session.getRemoteAddress());
            session.close(4000, "Missing itemId");
            return;
        }

        offerSessions.computeIfAbsent(String.valueOf(itemId), k -> ConcurrentHashMap.newKeySet()).add(session);
        logger.info("{} Connected to item id {}", session.getRemoteAddress().getHostName(), itemId);
    }

    @OnWebSocketClose
    public void onClose(Session session, int statusCode, String reason) {
        Long itemId = getItemIdFromQuery(session);
        if (itemId == null) return;

        Set<Session> sessions = offerSessions.get(itemId);
        if (sessions != null) sessions.remove(session);

        logger.info("Disconnected from item {}: {} ({})", itemId, session.getRemoteAddress(), reason);
    }

    private Long getItemIdFromQuery(Session session) {
        String query = session.getUpgradeRequest().getQueryString();
        if (query == null || query.isBlank()) return null;

        for (String param : query.split("&")) {
            int idx = param.indexOf('=');
            if (idx > 0) {
                String key = param.substring(0, idx);
                String value = param.substring(idx + 1);
                if ("itemId".equals(key)) {
                    try {
                        value = URLDecoder.decode(value, StandardCharsets.UTF_8);
                        return Long.parseLong(value);
                    } catch (Exception e) {
                        return null;
                    }
                }
            }
        }
        return null;
    }

    public static void broadCastMessage(EventType eventType, String itemId, Object obj) {
        Set<Session> sessions = offerSessions.get(itemId);
        if (sessions == null) return;

        WebSocketMessage message = WebSocketMessage.builder()
                .eventType(eventType)
                .data(obj)
                .build();

        for (Session s : Set.copyOf(sessions)) {
            if (s.isOpen()) {
                try {
                    s.getRemote().sendString(gson.toJson(message));
                } catch (IOException e) {
                    logger.warn("Failed to send message: {}", e.getMessage());
                }
            } else {
                sessions.remove(s);
            }
        }
    }
}
package com.pikolinc.ws.message;

import com.pikolinc.infraestructure.events.EventType;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;

@Data
@Builder
@AllArgsConstructor
public class WebSocketMessage {
    private final EventType eventType;
    private final Object data;
}
<configuration>
    <appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>

    <root level="INFO">
        <appender-ref ref="STDOUT" />
    </root>
</configuration>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Java Spark Auctions</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css"
          integrity="sha384-X38yfunGUhNzHpBaEBsWLO+A0HDYOQi8ufWDkZ0k9e0eXz/tH3II7uKZ9msv++Ls"
          crossorigin="anonymous">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0a0a0a;
            min-height: 100vh;
            padding: 2rem;
            color: #e0e0e0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: linear-gradient(145deg, #1a1a1a, #0f0f0f);
            border-radius: 16px;
            border: 1px solid #2a2a2a;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            padding: 3rem;
            position: relative;
            overflow: hidden;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, #666, transparent);
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #2a2a2a;
            position: relative;
        }

        header::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, #444, transparent);
        }

        h1 {
            color: #ffffff;
            font-size: 2.5rem;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        #status {
            font-size: 0.85rem;
            color: #888;
            padding: 0.5rem 1.2rem;
            background: linear-gradient(135deg, #1f1f1f, #2a2a2a);
            border: 1px solid #333;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
        }

        #status.connected {
            color: #6ee7b7;
            border-color: #065f46;
            background: linear-gradient(135deg, #064e3b, #065f46);
        }

        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-group label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
            font-weight: 500;
        }

        .filter-input {
            padding: 0.7rem 1rem;
            font-size: 0.9rem;
            border-radius: 6px;
            border: 1px solid #2a2a2a;
            background: linear-gradient(145deg, #1a1a1a, #0f0f0f);
            color: #ffffff;
            font-family: inherit;
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .filter-input:focus {
            outline: none;
            border-color: #555;
            box-shadow: 0 0 0 3px rgba(85, 85, 85, 0.2);
            background: #1f1f1f;
        }

        .filter-input::placeholder {
            color: #555;
        }

        .filter-btn {
            padding: 0.7rem 1.5rem;
            font-size: 0.85rem;
            border-radius: 6px;
            border: 1px solid #2a2a2a;
            background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
            color: #ffffff;
            cursor: pointer;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            align-self: flex-end;
        }

        .filter-btn:hover {
            border-color: #666;
            box-shadow: 0 4px 15px rgba(102, 102, 102, 0.2);
            transform: translateY(-1px);
        }

        .filter-btn:active {
            transform: translateY(0);
        }

        .results-info {
            color: #888;
            font-size: 0.85rem;
            margin-bottom: 1rem;
            padding: 0.5rem 0;
        }

        .results-info span {
            color: #fff;
            font-weight: 500;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .create-btn {
            padding: 0.8rem 2rem;
            font-size: 0.9rem;
            border-radius: 6px;
            border: 1px solid #444;
            background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
            color: #ffffff;
            cursor: pointer;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }

        .create-btn:hover {
            border-color: #666;
            box-shadow: 0 4px 15px rgba(102, 102, 102, 0.2);
            transform: translateY(-1px);
        }

        .item-actions {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn-small {
            padding: 0.4rem 0.8rem;
            font-size: 0.7rem;
            border-radius: 4px;
            border: 1px solid #2a2a2a;
            background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
            color: #b0b0b0;
            cursor: pointer;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s ease;
        }

        .action-btn-small:hover {
            border-color: #666;
            color: #fff;
            transform: translateY(-1px);
        }

        .action-btn-small.edit {
            border-color: #3a4a5a;
            background: linear-gradient(135deg, #2a3a4a, #1f2f3f);
            color: #6b9fff;
        }

        .action-btn-small.edit:hover {
            border-color: #6b9fff;
        }

        .action-btn-small.delete {
            border-color: #5a1f1f;
            background: linear-gradient(135deg, #3a1515, #2a1010);
            color: #ff6b6b;
        }

        .action-btn-small.delete:hover {
            border-color: #ff6b6b;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(145deg, #1a1a1a, #0f0f0f);
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
        }

        .modal-header {
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            color: #ffffff;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .form-input {
            width: 100%;
            padding: 0.8rem 1rem;
            font-size: 0.95rem;
            border-radius: 6px;
            border: 1px solid #2a2a2a;
            background: linear-gradient(145deg, #1a1a1a, #0f0f0f);
            color: #ffffff;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #555;
            box-shadow: 0 0 0 3px rgba(85, 85, 85, 0.2);
            background: #1f1f1f;
        }

        .form-input::placeholder {
            color: #555;
        }

        textarea.form-input {
            resize: vertical;
            min-height: 100px;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        .modal-btn {
            padding: 0.7rem 1.5rem;
            font-size: 0.85rem;
            border-radius: 6px;
            border: 1px solid #2a2a2a;
            background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
            color: #ffffff;
            cursor: pointer;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }

        .modal-btn:hover {
            border-color: #666;
            transform: translateY(-1px);
        }

        .modal-btn.primary {
            border-color: #444;
        }

        .modal-btn.cancel {
            background: transparent;
            border-color: #333;
            color: #888;
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid #2a2a2a;
            background: #0f0f0f;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        th, td {
            padding: 1.2rem 1.5rem;
            text-align: left;
            border-bottom: 1px solid #1a1a1a;
        }

        th {
            background: linear-gradient(180deg, #2a2a2a 0%, #1f1f1f 100%);
            color: #ffffff;
            cursor: pointer;
            user-select: none;
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 1.5px;
            transition: all 0.2s ease;
            position: relative;
        }

        th::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #666, transparent);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        th:hover {
            background: linear-gradient(180deg, #333 0%, #2a2a2a 100%);
        }

        th:hover::after {
            opacity: 1;
        }

        tbody tr {
            transition: all 0.2s ease;
        }

        tbody tr:hover {
            background: linear-gradient(90deg, #1a1a1a, #1f1f1f);
            border-left: 2px solid #666;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        td {
            color: #b0b0b0;
            font-size: 0.95rem;
        }

        .no-items {
            text-align: center;
            color: #555;
            padding: 3rem;
            font-size: 1rem;
        }

        .pure-button {
            padding: 0.6rem 1.5rem;
            font-size: 0.85rem;
            border-radius: 6px;
            border: 1px solid #2a2a2a;
            background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
            color: #ffffff;
            cursor: pointer;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .pure-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s ease;
        }

        .pure-button-primary {
            border-color: #444;
        }

        .pure-button:hover {
            border-color: #666;
            box-shadow: 0 4px 15px rgba(102, 102, 102, 0.2);
            transform: translateY(-1px);
        }

        .pure-button:hover::before {
            left: 100%;
        }

        .pure-button:active {
            transform: translateY(0);
        }

        .sort-arrow {
            margin-left: 6px;
            font-size: 0.7rem;
            opacity: 0.7;
            color: #888;
        }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }

            .container {
                padding: 1.5rem;
            }

            h1 {
                font-size: 2rem;
            }

            header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            th, td {
                padding: 0.8rem 1rem;
                font-size: 0.85rem;
            }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0f0f0f;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #444;
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>Available Items</h1>
        <span id="status">Connecting...</span>
    </header>

    <section>
        <div class="action-buttons">
            <button class="create-btn" onclick="openCreateModal()">+ Create New Item</button>
        </div>

        <div class="filters">
            <div class="filter-group">
                <label for="filter-name">Search Name</label>
                <input type="text" id="filter-name" class="filter-input" placeholder="Item name...">
            </div>
            <div class="filter-group">
                <label for="filter-description">Search Description</label>
                <input type="text" id="filter-description" class="filter-input" placeholder="Description...">
            </div>
            <div class="filter-group">
                <label for="filter-min-price">Min Price</label>
                <input type="number" id="filter-min-price" class="filter-input" placeholder="$0" min="0">
            </div>
            <div class="filter-group">
                <label for="filter-max-price">Max Price</label>
                <input type="number" id="filter-max-price" class="filter-input" placeholder="Any" min="0">
            </div>
            <button class="filter-btn" onclick="clearFilters()">Clear Filters</button>
        </div>

        <div class="results-info">
            Showing <span id="visible-count">0</span> of <span id="total-count">0</span> items
        </div>

        <div class="table-wrapper">
            <table id="items-table" class="pure-table pure-table-horizontal">
                <thead>
                <tr>
                    <th data-sort="name">Name <span class="sort-arrow"></span></th>
                    <th data-sort="description">Description <span class="sort-arrow"></span></th>
                    <th data-sort="price">Price <span class="sort-arrow"></span></th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="items-body">
                {{#items}}
                    <tr data-id="{{id}}">
                        <td>{{name}}</td>
                        <td>{{description}}</td>
                        <td>${{price}}</td>
                        <td>
                            <div class="item-actions">
                                <button class="pure-button pure-button-primary" onclick="openOffers({{id}})">View Offers</button>
                                <button class="action-btn-small edit" onclick="openEditModal({{id}})">Edit</button>
                                <button class="action-btn-small delete" onclick="deleteItem({{id}})">Delete</button>
                            </div>
                        </td>
                    </tr>
                {{/items}}

                {{^items}}
                    <tr id="no-items"><td colspan="4" class="no-items">No items found.</td></tr>
                {{/items}}
                </tbody>
            </table>
        </div>
    </section>
</div>

<!-- Modal for Create/Edit Item -->
<div id="itemModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Create New Item</h2>
        </div>
        <form id="itemForm">
            <input type="hidden" id="itemId">
            <div class="form-group">
                <label for="itemName">Name *</label>
                <input type="text" id="itemName" class="form-input" placeholder="Enter item name" required>
            </div>
            <div class="form-group">
                <label for="itemDescription">Description</label>
                <textarea id="itemDescription" class="form-input" placeholder="Enter item description"></textarea>
            </div>
            <div class="form-group">
                <label for="itemPrice">Price *</label>
                <input type="number" id="itemPrice" class="form-input" placeholder="0.00" min="0" step="0.01" required>
            </div>
            <div class="modal-actions">
                <button type="button" class="modal-btn cancel" onclick="closeModal()">Cancel</button>
                <button type="submit" class="modal-btn primary">Save Item</button>
            </div>
        </form>
    </div>
</div>

<script>
    const ws = new WebSocket("ws://" + window.location.host + "/ws");
    const tbody = document.getElementById("items-body");
    const statusEl = document.getElementById("status");

    // Filter elements
    const filterName = document.getElementById("filter-name");
    const filterDescription = document.getElementById("filter-description");
    const filterMinPrice = document.getElementById("filter-min-price");
    const filterMaxPrice = document.getElementById("filter-max-price");

    // Modal elements
    const modal = document.getElementById("itemModal");
    const modalTitle = document.getElementById("modalTitle");
    const itemForm = document.getElementById("itemForm");
    const itemIdInput = document.getElementById("itemId");
    const itemNameInput = document.getElementById("itemName");
    const itemDescriptionInput = document.getElementById("itemDescription");
    const itemPriceInput = document.getElementById("itemPrice");


    // Close modal when clicking outside
    modal.addEventListener("click", (e) => {
        if (e.target === modal) closeModal();
    });

    // Handle form submission
    itemForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const itemId = itemIdInput.value;
        const name = itemNameInput.value.trim();
        const description = itemDescriptionInput.value.trim();
        const price = parseFloat(itemPriceInput.value);

        if (!name || isNaN(price)) {
            alert("Please fill in all required fields");
            return;
        }

        const itemData = {name, description, price};
        const method = itemId ? "PUT" : "POST";
        const url = itemId ? `/items/${itemId}` : "/items";

        try {
            const response = await fetch('/api/v1/' + url, {
                method,
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(itemData)
            });

            if (response.ok) {
                closeModal();
            } else {
                const error = await response.text();
                alert(`Error: ${error}`);
            }
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    });

    async function deleteItem(itemId) {
        if (!confirm("Are you sure you want to delete this item?")) return;

        try {
            const response = await fetch(`/api/v1/items/${itemId}`, {method: "DELETE"});
            if (!response.ok) {
                const error = await response.text();
                alert(`Error: ${error}`);
            }
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    }

    // Handle back button navigation
    window.addEventListener('pageshow', function(event) {
        if (event.persisted || performance.getEntriesByType("navigation")[0].type === "back_forward") {
            // Page was loaded from cache (back button used)
            // Re-initialize data attributes for existing rows
            const existingRows = tbody.querySelectorAll("tr[data-id]");
            existingRows.forEach(row => {
                const name = row.children[0].textContent;
                const description = row.children[1].textContent;
                const priceText = row.children[2].textContent;
                const price = parseFloat(priceText.replace('$', ''));

                row.dataset.name = name.toLowerCase();
                row.dataset.description = description.toLowerCase();
                row.dataset.price = price;
            });

            // Update counts and apply any active filters
            updateCounts();
            applyFilters();
        }
    });

    // Add event listeners for real-time filtering
    [filterName, filterDescription, filterMinPrice, filterMaxPrice].forEach(input => {
        input.addEventListener("input", applyFilters);
    });

    ws.onopen = () => {
        statusEl.textContent = "Connected";
        statusEl.classList.add("connected");
        const ids = [...document.querySelectorAll('tr[data-id]')].map(el => el.dataset.id);
        ws.send(JSON.stringify({action: "subscribe", itemIds: ids}));
        ws.send(JSON.stringify({action: "subscribeAll"}));
        updateCounts();
    };

    ws.onmessage = event => {
        const msg = JSON.parse(event.data);
        const {eventType, data} = msg;

        if (eventType === "ITEM_CREATED") addItem(data);
        else if (eventType === "ITEM_UPDATED") updateItem(data);
        else if (eventType === "ITEM_DELETED") removeItem(data);
    };

    ws.onclose = () => {
        statusEl.textContent = "Disconnected";
        statusEl.classList.remove("connected");
    };

    function openCreateModal() {
        modalTitle.textContent = "Create New Item";
        itemForm.reset();
        itemIdInput.value = "";
        modal.classList.add("active");
    }

    function openEditModal(itemId) {
        const row = document.querySelector(`[data-id="${itemId}"]`);
        if (!row) return;

        modalTitle.textContent = "Edit Item";
        itemIdInput.value = itemId;
        itemNameInput.value = row.children[0].textContent;
        itemDescriptionInput.value = row.children[1].textContent;
        itemPriceInput.value = row.children[2].textContent.replace('$', '');
        modal.classList.add("active");
    }

    function closeModal() {
        modal.classList.remove("active");
        itemForm.reset();
    }


    function addItem(item) {
        // Remove "no items" row if present
        const noItemsRow = document.getElementById("no-items");
        if (noItemsRow) noItemsRow.remove();

        // Create a new table row
        const row = document.createElement("tr");
        row.dataset.id = item.id;
        row.dataset.name = item.name.toLowerCase();
        row.dataset.description = item.description.toLowerCase();
        row.dataset.price = item.price;

        row.innerHTML = `
        <td>${item.name}</td>
        <td>${item.description}</td>
        <td>$${item.price}</td>
        <td>
            <div class="item-actions">
                <button class="pure-button pure-button-primary" onclick="openOffers(${item.id})">View Offers</button>
                <button class="action-btn-small edit" onclick="openEditModal(${item.id})">Edit</button>
                <button class="action-btn-small delete" onclick="deleteItem(${item.id})">Delete</button>
            </div>
        </td>
    `;

        // Add to table
        tbody.appendChild(row);

        updateCounts();
        applyFilters();
    }


    function updateItem(item) {
        const tr = document.querySelector(`[data-id="${item.id}"]`);
        if (!tr) return addItem(item);
        tr.dataset.name = item.name.toLowerCase();
        tr.dataset.description = (item.description || "").toLowerCase();
        tr.dataset.price = item.price;
        tr.children[0].textContent = item.name;
        tr.children[1].textContent = item.description || "";
        tr.children[2].textContent = `${item.price}`;
        applyFilters();
    }

    function removeItem(itemId) {
        const tr = document.querySelector(`[data-id="${itemId}"]`);
        if (tr) tr.remove();
        if (!tbody.children.length) {
            tbody.innerHTML = `<tr id="no-items"><td colspan="4" class="no-items">No items found.</td></tr>`;
        }
        updateCounts();
    }

    function openOffers(itemId) {
        window.location.href = `/items/${itemId}/offers`;
    }

    function applyFilters() {
        const nameFilter = filterName.value.toLowerCase().trim();
        const descFilter = filterDescription.value.toLowerCase().trim();
        const minPrice = filterMinPrice.value ? parseFloat(filterMinPrice.value) : null;
        const maxPrice = filterMaxPrice.value ? parseFloat(filterMaxPrice.value) : null;

        const rows = tbody.querySelectorAll("tr[data-id]");
        let visibleCount = 0;

        rows.forEach(row => {
            const name = row.dataset.name || "";
            const description = row.dataset.description || "";
            const price = parseFloat(row.dataset.price);

            let visible = true;

            if (nameFilter && !name.includes(nameFilter)) visible = false;
            if (descFilter && !description.includes(descFilter)) visible = false;
            if (minPrice !== null && price < minPrice) visible = false;
            if (maxPrice !== null && price > maxPrice) visible = false;

            row.style.display = visible ? "" : "none";
            if (visible) visibleCount++;
        });

        updateCounts();
    }

    function clearFilters() {
        filterName.value = "";
        filterDescription.value = "";
        filterMinPrice.value = "";
        filterMaxPrice.value = "";
        applyFilters();
    }

    function updateCounts() {
        const allRows = tbody.querySelectorAll("tr[data-id]");
        const visibleRows = tbody.querySelectorAll("tr[data-id]:not([style*='display: none'])");
        document.getElementById("total-count").textContent = allRows.length;
        document.getElementById("visible-count").textContent = visibleRows.length;
    }

    let sortDirection = 1;
    let currentSortKey = null;

    document.querySelectorAll("th[data-sort]").forEach(th => {
        th.addEventListener("click", () => {
            const key = th.dataset.sort;
            if (currentSortKey === key) sortDirection *= -1;
            else {
                currentSortKey = key;
                sortDirection = 1;
            }

            document.querySelectorAll(".sort-arrow").forEach(a => a.textContent = "");
            th.querySelector(".sort-arrow").textContent = sortDirection === 1 ? "â–²" : "â–¼";

            const rows = [...tbody.querySelectorAll("tr[data-id]")];
            rows.sort((a, b) => {
                const aVal = a.querySelector(`td:nth-child(${th.cellIndex + 1})`).textContent.trim().toLowerCase();
                const bVal = b.querySelector(`td:nth-child(${th.cellIndex + 1})`).textContent.trim().toLowerCase();
                return sortDirection * aVal.localeCompare(bVal, undefined, {numeric: true});
            });
            rows.forEach(r => tbody.append(r));
        });
    });

    // Handle back button navigation
    window.addEventListener('pageshow', function(event) {
        if (event.persisted || performance.getEntriesByType("navigation")[0].type === "back_forward") {
            // Page was loaded from cache (back button used)
            // Re-initialize data attributes for existing rows
            const existingRows = tbody.querySelectorAll("tr[data-id]");
            existingRows.forEach(row => {
                const name = row.children[0].textContent;
                const description = row.children[1].textContent;
                const priceText = row.children[2].textContent;
                const price = parseFloat(priceText.replace('$', ''));

                row.dataset.name = name.toLowerCase();
                row.dataset.description = description.toLowerCase();
                row.dataset.price = price;
            });

            // Update counts and apply any active filters
            updateCounts();
            applyFilters();
        }
    });
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Offers for {{item.name}}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0a0a0a;
            min-height: 100vh;
            padding: 2rem;
            padding-right: 380px;
            margin-bottom: 140px;
            color: #e0e0e0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: linear-gradient(145deg, #1a1a1a, #0f0f0f);
            border-radius: 16px;
            border: 1px solid #2a2a2a;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            padding: 3rem;
            position: relative;
            overflow: hidden;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, #666, transparent);
        }

        h1 {
            color: #ffffff;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .item-details {
            background: linear-gradient(135deg, #1f1f1f 0%, #2a2a2a 100%);
            padding: 1.5rem;
            border-radius: 12px;
            margin: 2rem 0;
            border: 1px solid #333;
            position: relative;
            overflow: hidden;
        }

        .item-details::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #888, #555);
        }

        .item-details p {
            color: #b0b0b0;
            margin: 0.8rem 0;
            font-size: 1rem;
            padding-left: 1rem;
        }

        .item-details strong {
            color: #fff;
            font-weight: 500;
            margin-right: 0.5rem;
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid #2a2a2a;
            background: #0f0f0f;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        th, td {
            padding: 1.2rem 1.5rem;
            text-align: left;
        }

        th {
            background: linear-gradient(180deg, #2a2a2a 0%, #1f1f1f 100%);
            color: #ffffff;
            cursor: pointer;
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 1.5px;
            border-bottom: 1px solid #333;
            transition: all 0.2s ease;
            position: relative;
        }

        th::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #666, transparent);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        th:hover {
            background: linear-gradient(180deg, #333 0%, #2a2a2a 100%);
        }

        th:hover::after {
            opacity: 1;
        }

        tbody tr {
            border-bottom: 1px solid #1a1a1a;
            transition: all 0.2s ease;
        }

        tbody tr:hover {
            background: linear-gradient(90deg, #1a1a1a, #1f1f1f);
            border-left: 2px solid #666;
        }

        tbody tr:last-child {
            border-bottom: none;
        }

        td {
            color: #b0b0b0;
            font-size: 0.95rem;
        }

        .status {
            font-weight: 500;
            text-transform: uppercase;
            padding: 0.4rem 1rem;
            border-radius: 6px;
            display: inline-block;
            font-size: 0.75rem;
            letter-spacing: 1px;
            background: linear-gradient(135deg, #2a2a2a, #1f1f1f);
            color: #888;
            border: 1px solid #333;
        }

        .actions-cell {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 0.4rem 0.8rem;
            font-size: 0.7rem;
            border-radius: 4px;
            border: 1px solid #2a2a2a;
            background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
            color: #b0b0b0;
            cursor: pointer;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            border-color: #666;
            color: #fff;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(102, 102, 102, 0.2);
        }

        .action-btn.rebid {
            border-color: #3a3a1f;
            background: linear-gradient(135deg, #2a2a15, #1f1f10);
            color: #ffeb6b;
        }

        .action-btn.rebid:hover {
            border-color: #ffeb6b;
            box-shadow: 0 2px 8px rgba(255, 235, 107, 0.3);
        }

        .action-btn:active {
            transform: translateY(0);
        }

        .action-btn.delete {
            border-color: #5a1f1f;
            background: linear-gradient(135deg, #3a1515, #2a1010);
            color: #ff6b6b;
        }

        .action-btn.delete:hover {
            border-color: #ff6b6b;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
        }

        .action-btn.accept {
            border-color: #1f5a3a;
            background: linear-gradient(135deg, #153a25, #102a1a);
            color: #6bff9b;
        }

        .action-btn.accept:hover {
            border-color: #6bff9b;
            box-shadow: 0 2px 8px rgba(107, 255, 155, 0.3);
        }

        /* Mobile toggle button */
        .mobile-toggle {
            display: none;
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
            color: #ffffff;
            border: 1px solid #444;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            cursor: pointer;
            z-index: 1003;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.8);
            font-size: 1.5rem;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .mobile-toggle:hover {
            transform: scale(1.1);
            border-color: #666;
        }

        .mobile-toggle:active {
            transform: scale(0.95);
        }

        /* Sticky offer form */
        #new-offer-form {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 350px;
            background: linear-gradient(180deg, #1a1a1a 0%, #0f0f0f 100%);
            border-top: 1px solid #2a2a2a;
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.8);
            padding: 1.5rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            z-index: 1002;
        }

        #new-offer-form::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, #666, transparent);
        }

        #new-offer-form input, #new-offer-form button {
            padding: 0.9rem 1.5rem;
            font-size: 0.95rem;
            border-radius: 8px;
            border: 1px solid #2a2a2a;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        #new-offer-form input {
            background: linear-gradient(145deg, #1a1a1a, #0f0f0f);
            color: #ffffff;
            min-width: 200px;
        }

        #new-offer-form input:focus {
            outline: none;
            border-color: #555;
            box-shadow: 0 0 0 3px rgba(85, 85, 85, 0.2);
            background: #1f1f1f;
        }

        #new-offer-form input::placeholder {
            color: #555;
        }

        #new-offer-form input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #new-offer-form button {
            background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
            color: #ffffff;
            cursor: pointer;
            border: 1px solid #444;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 0.9rem 2.5rem;
            position: relative;
            overflow: hidden;
        }

        #new-offer-form button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s ease;
        }

        #new-offer-form button:hover {
            border-color: #666;
            box-shadow: 0 4px 20px rgba(102, 102, 102, 0.3);
        }

        #new-offer-form button:hover::before {
            left: 100%;
        }

        #new-offer-form button:active {
            transform: translateY(1px);
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #555;
            font-size: 1rem;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            right: 0;
            width: 350px;
            height: 100vh;
            background: linear-gradient(180deg, #1a1a1a 0%, #0f0f0f 100%);
            border-left: 1px solid #2a2a2a;
            box-shadow: -10px 0 40px rgba(0, 0, 0, 0.8);
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 2rem 1.5rem 1rem;
            border-bottom: 1px solid #2a2a2a;
            position: sticky;
            top: 0;
            background: linear-gradient(180deg, #1a1a1a 0%, #0f0f0f 100%);
            z-index: 10;
        }

        .sidebar-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, #666, transparent);
        }

        .sidebar-header h2 {
            color: #ffffff;
            font-size: 1.2rem;
            font-weight: 600;
            letter-spacing: -0.5px;
            margin-bottom: 0.5rem;
        }

        .sidebar-header p {
            color: #666;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .sidebar-close {
            display: none;
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: transparent;
            border: none;
            color: #666;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            transition: color 0.2s ease;
        }

        .sidebar-close:hover {
            color: #fff;
        }

        .users-list {
            padding: 1rem;
        }

        .user-card {
            background: linear-gradient(135deg, #1f1f1f 0%, #1a1a1a 100%);
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .user-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 3px;
            height: 100%;
            background: linear-gradient(180deg, #666, #444);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .user-card:hover {
            border-color: #444;
            background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
            transform: translateX(-3px);
        }

        .user-card:hover::before {
            opacity: 1;
        }

        .user-card.selected {
            border-color: #6bff9b;
            background: linear-gradient(135deg, #102a1a 0%, #153a25 100%);
        }

        .user-card.selected::before {
            background: linear-gradient(180deg, #6bff9b, #4dd87d);
            opacity: 1;
        }

        .user-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .user-name {
            color: #ffffff;
            font-weight: 500;
            font-size: 1rem;
        }

        .user-id {
            color: #666;
            font-size: 0.75rem;
            background: #0f0f0f;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }

        .user-card.selected .user-id {
            background: #1f3a2a;
            color: #6bff9b;
        }

        .user-info {
            color: #888;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .user-info strong {
            color: #aaa;
        }

        .user-email {
            color: #888;
            font-size: 0.8rem;
            margin-top: 0.3rem;
            font-family: 'Courier New', monospace;
        }

        .sidebar-loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .sidebar-error {
            text-align: center;
            padding: 2rem;
            color: #ff6b6b;
        }

        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .mobile-overlay.active {
            opacity: 1;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            body {
                padding: 1.5rem;
                padding-right: 1.5rem;
                margin-bottom: 140px;
            }

            .mobile-toggle {
                display: flex;
                bottom: 120px;
            }

            .sidebar {
                transform: translateX(100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .sidebar-close {
                display: block;
            }

            .mobile-overlay {
                display: block;
            }

            #new-offer-form {
                right: 0;
            }

            #new-offer-form input[name="userId"] {
                display: block;
                min-width: auto;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
                margin-bottom: 140px;
            }

            .container {
                padding: 1.5rem;
            }

            h1 {
                font-size: 2rem;
            }

            .sidebar {
                width: 100%;
                max-width: 350px;
            }

            #new-offer-form {
                flex-direction: column;
                padding: 1rem;
                gap: 0.75rem;
            }

            #new-offer-form input,
            #new-offer-form button {
                width: 100%;
                min-width: auto;
            }

            th, td {
                padding: 0.8rem 1rem;
                font-size: 0.85rem;
            }

            .action-btn {
                font-size: 0.65rem;
                padding: 0.3rem 0.6rem;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 1rem;
            }

            h1 {
                font-size: 1.5rem;
            }

            .item-details p {
                font-size: 0.9rem;
            }

            th, td {
                padding: 0.6rem 0.8rem;
                font-size: 0.8rem;
            }

            .mobile-toggle {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0f0f0f;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #444;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Offers for {{item.name}}</h1>

    <div class="item-details">
        <p><strong>Description:</strong> {{item.description}}</p>
        <p><strong>Base price:</strong> ${{item.price}}</p>
    </div>

    <div class="table-wrapper">
        <table id="offersTable">
            <thead>
            <tr>
                <th>ID</th>
                <th>User</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Created At</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody id="offersBody">
            {{#offers}}
                <tr data-offer-id="{{id}}">
                    <td>{{id}}</td>
                    <td>{{userName}}</td>
                    <td>${{amount}}</td>
                    <td><span class="status">{{status}}</span></td>
                    <td>{{createdAt}}</td>
                    <td class="actions-cell">
                        <button class="action-btn accept" onclick="updateOfferStatusAction({{id}}, 'accept')">Accept</button>
                        <button class="action-btn" onclick="updateOfferStatusAction({{id}}, 'reject')">Reject</button>
                        <button class="action-btn" onclick="updateOfferStatusAction({{id}}, 'cancel')">Cancel</button>
                        <button class="action-btn" onclick="updateOfferStatusAction({{id}}, 'complete')">Complete</button>
                        <button class="action-btn rebid" onclick="rebidOffer({{id}})">Rebid</button>
                        <button class="action-btn delete" onclick="deleteOffer({{id}})">Delete</button>
                    </td>
                </tr>
            {{/offers}}
            {{^offers}}
                <tr><td colspan="6" class="empty-state">No offers yet</td></tr>
            {{/offers}}
            </tbody>
        </table>
    </div>
</div>

<!-- Mobile overlay -->
<div class="mobile-overlay" id="mobileOverlay" onclick="closeSidebar()"></div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <button class="sidebar-close" onclick="closeSidebar()">âœ•</button>
        <h2>Available Users</h2>
        <p id="usersCount">Loading...</p>
    </div>
    <div id="usersList" class="users-list">
        <div class="sidebar-loading">Loading users...</div>
    </div>
</div>

<!-- Mobile toggle button -->
<button class="mobile-toggle" id="mobileToggle" onclick="toggleSidebar()">
    ðŸ‘¥
</button>

<!-- Sticky form -->
<form id="new-offer-form">
    <input type="number" name="userId" placeholder="User ID" min="1" required style="display: none;" />
    <input type="number" name="amount" placeholder="Offer amount" min="1" required />
    <button type="submit">Create Offer</button>
</form>

<script>
    const itemId = "{{item.id}}";
    const tableBody = document.getElementById("offersBody");
    let selectedUserId = null;
    let users = [];

    // Sidebar toggle functions
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('mobileOverlay');
        sidebar.classList.toggle('active');
        overlay.classList.toggle('active');
    }

    function closeSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('mobileOverlay');
        sidebar.classList.remove('active');
        overlay.classList.remove('active');
    }

    // Load users
    async function loadUsers() {
        try {
            const res = await fetch('/api/v1/users');
            if (!res.ok) throw new Error('Failed to fetch users');

            users = await res.json();
            renderUsers();
        } catch (err) {
            console.error('âŒ Error loading users:', err);
            document.getElementById('usersList').innerHTML = '<div class="sidebar-error">Failed to load users</div>';
        }
    }

    function renderUsers() {
        const usersList = document.getElementById('usersList');
        const usersCount = document.getElementById('usersCount');

        if (users.length === 0) {
            usersList.innerHTML = '<div class="sidebar-loading">No users available</div>';
            usersCount.textContent = '0 users';
            return;
        }

        usersCount.textContent = `${users.length} user${users.length !== 1 ? 's' : ''}`;

        usersList.innerHTML = users.map(user => `
            <div class="user-card" data-user-id="${user.id}" onclick="selectUser(${user.id})">
                <div class="user-card-header">
                    <span class="user-name">${user.name}</span>
                    <span class="user-id">ID: ${user.id}</span>
                </div>
                <div class="user-info">
                    <strong>Age:</strong> ${user.age || 'N/A'}
                </div>
                <div class="user-email">${user.email}</div>
            </div>
        `).join('');
    }

    function selectUser(userId) {
        selectedUserId = userId;

        // Update visual selection
        document.querySelectorAll('.user-card').forEach(card => {
            card.classList.remove('selected');
        });
        document.querySelector(`[data-user-id="${userId}"]`).classList.add('selected');

        // Update form
        const userIdInput = document.querySelector('#new-offer-form input[name="userId"]');
        userIdInput.value = userId;

        // Enable amount input on mobile
        const amountInput = document.querySelector('#new-offer-form input[name="amount"]');
        amountInput.disabled = false;
        amountInput.focus();

        // Close sidebar on mobile after selection
        if (window.innerWidth <= 1024) {
            setTimeout(closeSidebar, 300);
        }
    }

    // WebSocket for offers
    const ws = new WebSocket(`ws://${window.location.host}/ws/offers?itemId=${itemId}`);
    ws.onopen = () => console.log("âœ… Connected to offers WebSocket for item", itemId);
    ws.onclose = () => console.log("ðŸ”´ Disconnected from offers WebSocket");
    ws.onerror = (err) => console.error("WebSocket error:", err);

    ws.onmessage = (msg) => {
        let parsed;
        try {
            parsed = JSON.parse(msg.data);
        } catch (e) {
            console.error("Invalid WS data", msg.data);
            return;
        }

        const { eventType, data } = parsed;
        const offer = typeof data === "string" ? JSON.parse(data) : data;
        console.log("ðŸ“© Offer event received:", eventType, offer);

        switch (eventType) {
            case "OFFER_CREATED":
            case "OFFER_UPDATED":
            case "OFFER_REBID":
                upsertOfferRow(offer);
                break;
            case "OFFER_DELETED":
                removeOfferRow(offer.id);
                break;
            case "OFFER_REJECTED":
            case "OFFER_CANCELLED":
            case "OFFER_COMPLETED":
            case "OFFER_ACCEPTED":
                updateOfferStatusDisplay(offer);
                break;
        }
    };

    function updateOfferStatusDisplay(offer) {
        const row = document.querySelector(`tr[data-offer-id='${offer.id}']`);
        if (!row) return;
        row.querySelector(".status").textContent = offer.status;
    }

    function upsertOfferRow(offer) {
        const emptyRow = document.querySelector('.empty-state');
        if (emptyRow && emptyRow.closest('tr')) {
            emptyRow.closest('tr').remove();
        }

        let row = document.querySelector(`tr[data-offer-id='${offer.id}']`);
        if (!row) {
            row = document.createElement("tr");
            row.dataset.offerId = offer.id;
            row.innerHTML = `
                <td>${offer.id}</td>
                <td>${offer.userName}</td>
                <td>$${offer.amount}</td>
                <td><span class="status">${offer.status}</span></td>
                <td>${offer.createdAt}</td>
                <td class="actions-cell">
                    <button class="action-btn accept" onclick="updateOfferStatusAction(${offer.id}, 'accept')">Accept</button>
                    <button class="action-btn" onclick="updateOfferStatusAction(${offer.id}, 'reject')">Reject</button>
                    <button class="action-btn" onclick="updateOfferStatusAction(${offer.id}, 'cancel')">Cancel</button>
                    <button class="action-btn" onclick="updateOfferStatusAction(${offer.id}, 'complete')">Complete</button>
                    <button class="action-btn rebid" onclick="rebidOffer(${offer.id})">Rebid</button>
                    <button class="action-btn delete" onclick="deleteOffer(${offer.id})">Delete</button>
                </td>
            `;
            tableBody.appendChild(row);
        } else {
            row.querySelector("td:nth-child(2)").textContent = offer.userName;
            row.querySelector("td:nth-child(3)").textContent = `$${offer.amount}`;
            row.querySelector(".status").textContent = offer.status;
            row.querySelector("td:nth-child(5)").textContent = offer.createdAt;
        }
    }

    function removeOfferRow(id) {
        const row = document.querySelector(`tr[data-offer-id='${id}']`);
        if (row) row.remove();
    }

    // Actions
    async function updateOfferStatusAction(offerId, status) {
        try {
            const res = await fetch(`/api/v1/offers/${offerId}/${status}`, {
                method: "PUT"
            });

            if (!res.ok) throw new Error(await res.text());
            console.log(`âœ… Offer ${offerId} status updated to ${status}`);
        } catch (err) {
            console.error(`âŒ Error updating offer status:`, err);
            alert(`Failed to update offer status. Check console for details.`);
        }
    }

    async function deleteOffer(offerId) {
        if (!confirm(`Are you sure you want to delete offer #${offerId}?`)) return;

        try {
            const res = await fetch(`/api/v1/offers/${offerId}`, {
                method: "DELETE"
            });

            if (!res.ok) throw new Error(await res.text());
            console.log(`âœ… Offer ${offerId} deleted`);
        } catch (err) {
            console.error(`âŒ Error deleting offer:`, err);
            alert(`Failed to delete offer. Check console for details.`);
        }
    }

    async function rebidOffer(offerId) {
        const newAmount = prompt('Enter new offer amount:');
        if (!newAmount || isNaN(newAmount) || Number(newAmount) <= 0) {
            return;
        }

        try {
            const res = await fetch(`/api/v1/offers/${offerId}/amount`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ amount: Number(newAmount) })
            });

            if (!res.ok) throw new Error(await res.text());
            console.log(`âœ… Offer ${offerId} rebid to ${newAmount}`);
        } catch (err) {
            console.error(`âŒ Error rebidding offer:`, err);
            alert(`Failed to rebid offer. Check console for details.`);
        }
    }

    // ---- Table sorting logic ----
    const getCellValue = (tr, idx) => tr.children[idx].innerText || tr.children[idx].textContent;

    const comparer = (idx, asc) => (a, b) =>
            ((v1, v2) =>
                            v1 !== "" && v2 !== "" && !isNaN(v1) && !isNaN(v2)
                                    ? v1 - v2
                                    : v1.toString().localeCompare(v2)
            )(getCellValue(asc ? a : b, idx), getCellValue(asc ? b : a, idx));

    document.querySelectorAll("th").forEach((th, idx) =>
            th.addEventListener("click", () => {
                const table = th.closest("table");
                Array.from(table.querySelectorAll("tbody tr"))
                        .sort(comparer(idx, (this.asc = !this.asc)))
                        .forEach(tr => table.querySelector("tbody").appendChild(tr));
            })
    );

    // ---- Sticky form ----
    document.getElementById("new-offer-form").addEventListener("submit", async (e) => {
        e.preventDefault();

        if (!selectedUserId) {
            alert('Please select a user from the sidebar first');
            return;
        }

        const form = e.target;
        const finalPrice = form.amount.value;

        const payload = {
            userId: selectedUserId,
            itemId: Number(itemId),
            finalPrice: Number(finalPrice)
        };

        try {
            const res = await fetch("/api/v1/offers", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (!res.ok) throw new Error(await res.text());
            form.amount.value = '';
            console.log("âœ… Offer created successfully");
        } catch (err) {
            console.error("âŒ Error creating offer:", err);
            alert("Failed to create offer. Check console for details.");
        }
    });

    // Initialize
    loadUsers();
</script>

</body>
</html>
<configuration>
    <appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>

    <root level="INFO">
        <appender-ref ref="STDOUT" />
    </root>
</configuration>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Java Spark Auctions</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css"
          integrity="sha384-X38yfunGUhNzHpBaEBsWLO+A0HDYOQi8ufWDkZ0k9e0eXz/tH3II7uKZ9msv++Ls"
          crossorigin="anonymous">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0a0a0a;
            min-height: 100vh;
            padding: 2rem;
            color: #e0e0e0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: linear-gradient(145deg, #1a1a1a, #0f0f0f);
            border-radius: 16px;
            border: 1px solid #2a2a2a;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            padding: 3rem;
            position: relative;
            overflow: hidden;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, #666, transparent);
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #2a2a2a;
            position: relative;
        }

        header::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, #444, transparent);
        }

        h1 {
            color: #ffffff;
            font-size: 2.5rem;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        #status {
            font-size: 0.85rem;
            color: #888;
            padding: 0.5rem 1.2rem;
            background: linear-gradient(135deg, #1f1f1f, #2a2a2a);
            border: 1px solid #333;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
        }

        #status.connected {
            color: #6ee7b7;
            border-color: #065f46;
            background: linear-gradient(135deg, #064e3b, #065f46);
        }

        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-group label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
            font-weight: 500;
        }

        .filter-input {
            padding: 0.7rem 1rem;
            font-size: 0.9rem;
            border-radius: 6px;
            border: 1px solid #2a2a2a;
            background: linear-gradient(145deg, #1a1a1a, #0f0f0f);
            color: #ffffff;
            font-family: inherit;
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .filter-input:focus {
            outline: none;
            border-color: #555;
            box-shadow: 0 0 0 3px rgba(85, 85, 85, 0.2);
            background: #1f1f1f;
        }

        .filter-input::placeholder {
            color: #555;
        }

        .filter-btn {
            padding: 0.7rem 1.5rem;
            font-size: 0.85rem;
            border-radius: 6px;
            border: 1px solid #2a2a2a;
            background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
            color: #ffffff;
            cursor: pointer;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            align-self: flex-end;
        }

        .filter-btn:hover {
            border-color: #666;
            box-shadow: 0 4px 15px rgba(102, 102, 102, 0.2);
            transform: translateY(-1px);
        }

        .filter-btn:active {
            transform: translateY(0);
        }

        .results-info {
            color: #888;
            font-size: 0.85rem;
            margin-bottom: 1rem;
            padding: 0.5rem 0;
        }

        .results-info span {
            color: #fff;
            font-weight: 500;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .create-btn {
            padding: 0.8rem 2rem;
            font-size: 0.9rem;
            border-radius: 6px;
            border: 1px solid #444;
            background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
            color: #ffffff;
            cursor: pointer;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }

        .create-btn:hover {
            border-color: #666;
            box-shadow: 0 4px 15px rgba(102, 102, 102, 0.2);
            transform: translateY(-1px);
        }

        .item-actions {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn-small {
            padding: 0.4rem 0.8rem;
            font-size: 0.7rem;
            border-radius: 4px;
            border: 1px solid #2a2a2a;
            background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
            color: #b0b0b0;
            cursor: pointer;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s ease;
        }

        .action-btn-small:hover {
            border-color: #666;
            color: #fff;
            transform: translateY(-1px);
        }

        .action-btn-small.edit {
            border-color: #3a4a5a;
            background: linear-gradient(135deg, #2a3a4a, #1f2f3f);
            color: #6b9fff;
        }

        .action-btn-small.edit:hover {
            border-color: #6b9fff;
        }

        .action-btn-small.delete {
            border-color: #5a1f1f;
            background: linear-gradient(135deg, #3a1515, #2a1010);
            color: #ff6b6b;
        }

        .action-btn-small.delete:hover {
            border-color: #ff6b6b;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(145deg, #1a1a1a, #0f0f0f);
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
        }

        .modal-header {
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            color: #ffffff;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .form-input {
            width: 100%;
            padding: 0.8rem 1rem;
            font-size: 0.95rem;
            border-radius: 6px;
            border: 1px solid #2a2a2a;
            background: linear-gradient(145deg, #1a1a1a, #0f0f0f);
            color: #ffffff;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #555;
            box-shadow: 0 0 0 3px rgba(85, 85, 85, 0.2);
            background: #1f1f1f;
        }

        .form-input::placeholder {
            color: #555;
        }

        textarea.form-input {
            resize: vertical;
            min-height: 100px;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        .modal-btn {
            padding: 0.7rem 1.5rem;
            font-size: 0.85rem;
            border-radius: 6px;
            border: 1px solid #2a2a2a;
            background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
            color: #ffffff;
            cursor: pointer;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }

        .modal-btn:hover {
            border-color: #666;
            transform: translateY(-1px);
        }

        .modal-btn.primary {
            border-color: #444;
        }

        .modal-btn.cancel {
            background: transparent;
            border-color: #333;
            color: #888;
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid #2a2a2a;
            background: #0f0f0f;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        th, td {
            padding: 1.2rem 1.5rem;
            text-align: left;
            border-bottom: 1px solid #1a1a1a;
        }

        th {
            background: linear-gradient(180deg, #2a2a2a 0%, #1f1f1f 100%);
            color: #ffffff;
            cursor: pointer;
            user-select: none;
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 1.5px;
            transition: all 0.2s ease;
            position: relative;
        }

        th::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #666, transparent);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        th:hover {
            background: linear-gradient(180deg, #333 0%, #2a2a2a 100%);
        }

        th:hover::after {
            opacity: 1;
        }

        tbody tr {
            transition: all 0.2s ease;
        }

        tbody tr:hover {
            background: linear-gradient(90deg, #1a1a1a, #1f1f1f);
            border-left: 2px solid #666;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        td {
            color: #b0b0b0;
            font-size: 0.95rem;
        }

        .no-items {
            text-align: center;
            color: #555;
            padding: 3rem;
            font-size: 1rem;
        }

        .pure-button {
            padding: 0.6rem 1.5rem;
            font-size: 0.85rem;
            border-radius: 6px;
            border: 1px solid #2a2a2a;
            background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
            color: #ffffff;
            cursor: pointer;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .pure-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s ease;
        }

        .pure-button-primary {
            border-color: #444;
        }

        .pure-button:hover {
            border-color: #666;
            box-shadow: 0 4px 15px rgba(102, 102, 102, 0.2);
            transform: translateY(-1px);
        }

        .pure-button:hover::before {
            left: 100%;
        }

        .pure-button:active {
            transform: translateY(0);
        }

        .sort-arrow {
            margin-left: 6px;
            font-size: 0.7rem;
            opacity: 0.7;
            color: #888;
        }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }

            .container {
                padding: 1.5rem;
            }

            h1 {
                font-size: 2rem;
            }

            header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            th, td {
                padding: 0.8rem 1rem;
                font-size: 0.85rem;
            }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0f0f0f;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #444;
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>Available Items</h1>
        <span id="status">Connecting...</span>
    </header>

    <section>
        <div class="action-buttons">
            <button class="create-btn" onclick="openCreateModal()">+ Create New Item</button>
        </div>

        <div class="filters">
            <div class="filter-group">
                <label for="filter-name">Search Name</label>
                <input type="text" id="filter-name" class="filter-input" placeholder="Item name...">
            </div>
            <div class="filter-group">
                <label for="filter-description">Search Description</label>
                <input type="text" id="filter-description" class="filter-input" placeholder="Description...">
            </div>
            <div class="filter-group">
                <label for="filter-min-price">Min Price</label>
                <input type="number" id="filter-min-price" class="filter-input" placeholder="$0" min="0">
            </div>
            <div class="filter-group">
                <label for="filter-max-price">Max Price</label>
                <input type="number" id="filter-max-price" class="filter-input" placeholder="Any" min="0">
            </div>
            <button class="filter-btn" onclick="clearFilters()">Clear Filters</button>
        </div>

        <div class="results-info">
            Showing <span id="visible-count">0</span> of <span id="total-count">0</span> items
        </div>

        <div class="table-wrapper">
            <table id="items-table" class="pure-table pure-table-horizontal">
                <thead>
                <tr>
                    <th data-sort="name">Name <span class="sort-arrow"></span></th>
                    <th data-sort="description">Description <span class="sort-arrow"></span></th>
                    <th data-sort="price">Price <span class="sort-arrow"></span></th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="items-body">
                {{#items}}
                    <tr data-id="{{id}}">
                        <td>{{name}}</td>
                        <td>{{description}}</td>
                        <td>${{price}}</td>
                        <td>
                            <div class="item-actions">
                                <button class="pure-button pure-button-primary" onclick="openOffers({{id}})">View Offers</button>
                                <button class="action-btn-small edit" onclick="openEditModal({{id}})">Edit</button>
                                <button class="action-btn-small delete" onclick="deleteItem({{id}})">Delete</button>
                            </div>
                        </td>
                    </tr>
                {{/items}}

                {{^items}}
                    <tr id="no-items"><td colspan="4" class="no-items">No items found.</td></tr>
                {{/items}}
                </tbody>
            </table>
        </div>
    </section>
</div>

<!-- Modal for Create/Edit Item -->
<div id="itemModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Create New Item</h2>
        </div>
        <form id="itemForm">
            <input type="hidden" id="itemId">
            <div class="form-group">
                <label for="itemName">Name *</label>
                <input type="text" id="itemName" class="form-input" placeholder="Enter item name" required>
            </div>
            <div class="form-group">
                <label for="itemDescription">Description</label>
                <textarea id="itemDescription" class="form-input" placeholder="Enter item description"></textarea>
            </div>
            <div class="form-group">
                <label for="itemPrice">Price *</label>
                <input type="number" id="itemPrice" class="form-input" placeholder="0.00" min="0" step="0.01" required>
            </div>
            <div class="modal-actions">
                <button type="button" class="modal-btn cancel" onclick="closeModal()">Cancel</button>
                <button type="submit" class="modal-btn primary">Save Item</button>
            </div>
        </form>
    </div>
</div>

<script>
    const ws = new WebSocket("ws://" + window.location.host + "/ws");
    const tbody = document.getElementById("items-body");
    const statusEl = document.getElementById("status");

    // Filter elements
    const filterName = document.getElementById("filter-name");
    const filterDescription = document.getElementById("filter-description");
    const filterMinPrice = document.getElementById("filter-min-price");
    const filterMaxPrice = document.getElementById("filter-max-price");

    // Modal elements
    const modal = document.getElementById("itemModal");
    const modalTitle = document.getElementById("modalTitle");
    const itemForm = document.getElementById("itemForm");
    const itemIdInput = document.getElementById("itemId");
    const itemNameInput = document.getElementById("itemName");
    const itemDescriptionInput = document.getElementById("itemDescription");
    const itemPriceInput = document.getElementById("itemPrice");


    // Close modal when clicking outside
    modal.addEventListener("click", (e) => {
        if (e.target === modal) closeModal();
    });

    // Handle form submission
    itemForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const itemId = itemIdInput.value;
        const name = itemNameInput.value.trim();
        const description = itemDescriptionInput.value.trim();
        const price = parseFloat(itemPriceInput.value);

        if (!name || isNaN(price)) {
            alert("Please fill in all required fields");
            return;
        }

        const itemData = {name, description, price};
        const method = itemId ? "PUT" : "POST";
        const url = itemId ? `/items/${itemId}` : "/items";

        try {
            const response = await fetch('/api/v1/' + url, {
                method,
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(itemData)
            });

            if (response.ok) {
                closeModal();
            } else {
                const error = await response.text();
                alert(`Error: ${error}`);
            }
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    });

    async function deleteItem(itemId) {
        if (!confirm("Are you sure you want to delete this item?")) return;

        try {
            const response = await fetch(`/api/v1/items/${itemId}`, {method: "DELETE"});
            if (!response.ok) {
                const error = await response.text();
                alert(`Error: ${error}`);
            }
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    }

    // Handle back button navigation
    window.addEventListener('pageshow', function(event) {
        if (event.persisted || performance.getEntriesByType("navigation")[0].type === "back_forward") {
            // Page was loaded from cache (back button used)
            // Re-initialize data attributes for existing rows
            const existingRows = tbody.querySelectorAll("tr[data-id]");
            existingRows.forEach(row => {
                const name = row.children[0].textContent;
                const description = row.children[1].textContent;
                const priceText = row.children[2].textContent;
                const price = parseFloat(priceText.replace('$', ''));

                row.dataset.name = name.toLowerCase();
                row.dataset.description = description.toLowerCase();
                row.dataset.price = price;
            });

            // Update counts and apply any active filters
            updateCounts();
            applyFilters();
        }
    });

    // Add event listeners for real-time filtering
    [filterName, filterDescription, filterMinPrice, filterMaxPrice].forEach(input => {
        input.addEventListener("input", applyFilters);
    });

    ws.onopen = () => {
        statusEl.textContent = "Connected";
        statusEl.classList.add("connected");
        const ids = [...document.querySelectorAll('tr[data-id]')].map(el => el.dataset.id);
        ws.send(JSON.stringify({action: "subscribe", itemIds: ids}));
        ws.send(JSON.stringify({action: "subscribeAll"}));
        updateCounts();
    };

    ws.onmessage = event => {
        const msg = JSON.parse(event.data);
        const {eventType, data} = msg;

        if (eventType === "ITEM_CREATED") addItem(data);
        else if (eventType === "ITEM_UPDATED") updateItem(data);
        else if (eventType === "ITEM_DELETED") removeItem(data);
    };

    ws.onclose = () => {
        statusEl.textContent = "Disconnected";
        statusEl.classList.remove("connected");
    };

    function openCreateModal() {
        modalTitle.textContent = "Create New Item";
        itemForm.reset();
        itemIdInput.value = "";
        modal.classList.add("active");
    }

    function openEditModal(itemId) {
        const row = document.querySelector(`[data-id="${itemId}"]`);
        if (!row) return;

        modalTitle.textContent = "Edit Item";
        itemIdInput.value = itemId;
        itemNameInput.value = row.children[0].textContent;
        itemDescriptionInput.value = row.children[1].textContent;
        itemPriceInput.value = row.children[2].textContent.replace('$', '');
        modal.classList.add("active");
    }

    function closeModal() {
        modal.classList.remove("active");
        itemForm.reset();
    }


    function addItem(item) {
        // Remove "no items" row if present
        const noItemsRow = document.getElementById("no-items");
        if (noItemsRow) noItemsRow.remove();

        // Create a new table row
        const row = document.createElement("tr");
        row.dataset.id = item.id;
        row.dataset.name = item.name.toLowerCase();
        row.dataset.description = item.description.toLowerCase();
        row.dataset.price = item.price;

        row.innerHTML = `
        <td>${item.name}</td>
        <td>${item.description}</td>
        <td>$${item.price}</td>
        <td>
            <div class="item-actions">
                <button class="pure-button pure-button-primary" onclick="openOffers(${item.id})">View Offers</button>
                <button class="action-btn-small edit" onclick="openEditModal(${item.id})">Edit</button>
                <button class="action-btn-small delete" onclick="deleteItem(${item.id})">Delete</button>
            </div>
        </td>
    `;

        // Add to table
        tbody.appendChild(row);

        updateCounts();
        applyFilters();
    }


    function updateItem(item) {
        const tr = document.querySelector(`[data-id="${item.id}"]`);
        if (!tr) return addItem(item);
        tr.dataset.name = item.name.toLowerCase();
        tr.dataset.description = (item.description || "").toLowerCase();
        tr.dataset.price = item.price;
        tr.children[0].textContent = item.name;
        tr.children[1].textContent = item.description || "";
        tr.children[2].textContent = `${item.price}`;
        applyFilters();
    }

    function removeItem(itemId) {
        const tr = document.querySelector(`[data-id="${itemId}"]`);
        if (tr) tr.remove();
        if (!tbody.children.length) {
            tbody.innerHTML = `<tr id="no-items"><td colspan="4" class="no-items">No items found.</td></tr>`;
        }
        updateCounts();
    }

    function openOffers(itemId) {
        window.location.href = `/items/${itemId}/offers`;
    }

    function applyFilters() {
        const nameFilter = filterName.value.toLowerCase().trim();
        const descFilter = filterDescription.value.toLowerCase().trim();
        const minPrice = filterMinPrice.value ? parseFloat(filterMinPrice.value) : null;
        const maxPrice = filterMaxPrice.value ? parseFloat(filterMaxPrice.value) : null;

        const rows = tbody.querySelectorAll("tr[data-id]");
        let visibleCount = 0;

        rows.forEach(row => {
            const name = row.dataset.name || "";
            const description = row.dataset.description || "";
            const price = parseFloat(row.dataset.price);

            let visible = true;

            if (nameFilter && !name.includes(nameFilter)) visible = false;
            if (descFilter && !description.includes(descFilter)) visible = false;
            if (minPrice !== null && price < minPrice) visible = false;
            if (maxPrice !== null && price > maxPrice) visible = false;

            row.style.display = visible ? "" : "none";
            if (visible) visibleCount++;
        });

        updateCounts();
    }

    function clearFilters() {
        filterName.value = "";
        filterDescription.value = "";
        filterMinPrice.value = "";
        filterMaxPrice.value = "";
        applyFilters();
    }

    function updateCounts() {
        const allRows = tbody.querySelectorAll("tr[data-id]");
        const visibleRows = tbody.querySelectorAll("tr[data-id]:not([style*='display: none'])");
        document.getElementById("total-count").textContent = allRows.length;
        document.getElementById("visible-count").textContent = visibleRows.length;
    }

    let sortDirection = 1;
    let currentSortKey = null;

    document.querySelectorAll("th[data-sort]").forEach(th => {
        th.addEventListener("click", () => {
            const key = th.dataset.sort;
            if (currentSortKey === key) sortDirection *= -1;
            else {
                currentSortKey = key;
                sortDirection = 1;
            }

            document.querySelectorAll(".sort-arrow").forEach(a => a.textContent = "");
            th.querySelector(".sort-arrow").textContent = sortDirection === 1 ? "â–²" : "â–¼";

            const rows = [...tbody.querySelectorAll("tr[data-id]")];
            rows.sort((a, b) => {
                const aVal = a.querySelector(`td:nth-child(${th.cellIndex + 1})`).textContent.trim().toLowerCase();
                const bVal = b.querySelector(`td:nth-child(${th.cellIndex + 1})`).textContent.trim().toLowerCase();
                return sortDirection * aVal.localeCompare(bVal, undefined, {numeric: true});
            });
            rows.forEach(r => tbody.append(r));
        });
    });

    // Handle back button navigation
    window.addEventListener('pageshow', function(event) {
        if (event.persisted || performance.getEntriesByType("navigation")[0].type === "back_forward") {
            // Page was loaded from cache (back button used)
            // Re-initialize data attributes for existing rows
            const existingRows = tbody.querySelectorAll("tr[data-id]");
            existingRows.forEach(row => {
                const name = row.children[0].textContent;
                const description = row.children[1].textContent;
                const priceText = row.children[2].textContent;
                const price = parseFloat(priceText.replace('$', ''));

                row.dataset.name = name.toLowerCase();
                row.dataset.description = description.toLowerCase();
                row.dataset.price = price;
            });

            // Update counts and apply any active filters
            updateCounts();
            applyFilters();
        }
    });
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Offers for {{item.name}}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0a0a0a;
            min-height: 100vh;
            padding: 2rem;
            padding-right: 380px;
            margin-bottom: 140px;
            color: #e0e0e0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: linear-gradient(145deg, #1a1a1a, #0f0f0f);
            border-radius: 16px;
            border: 1px solid #2a2a2a;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            padding: 3rem;
            position: relative;
            overflow: hidden;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, #666, transparent);
        }

        h1 {
            color: #ffffff;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .item-details {
            background: linear-gradient(135deg, #1f1f1f 0%, #2a2a2a 100%);
            padding: 1.5rem;
            border-radius: 12px;
            margin: 2rem 0;
            border: 1px solid #333;
            position: relative;
            overflow: hidden;
        }

        .item-details::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #888, #555);
        }

        .item-details p {
            color: #b0b0b0;
            margin: 0.8rem 0;
            font-size: 1rem;
            padding-left: 1rem;
        }

        .item-details strong {
            color: #fff;
            font-weight: 500;
            margin-right: 0.5rem;
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid #2a2a2a;
            background: #0f0f0f;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        th, td {
            padding: 1.2rem 1.5rem;
            text-align: left;
        }

        th {
            background: linear-gradient(180deg, #2a2a2a 0%, #1f1f1f 100%);
            color: #ffffff;
            cursor: pointer;
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 1.5px;
            border-bottom: 1px solid #333;
            transition: all 0.2s ease;
            position: relative;
        }

        th::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #666, transparent);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        th:hover {
            background: linear-gradient(180deg, #333 0%, #2a2a2a 100%);
        }

        th:hover::after {
            opacity: 1;
        }

        tbody tr {
            border-bottom: 1px solid #1a1a1a;
            transition: all 0.2s ease;
        }

        tbody tr:hover {
            background: linear-gradient(90deg, #1a1a1a, #1f1f1f);
            border-left: 2px solid #666;
        }

        tbody tr:last-child {
            border-bottom: none;
        }

        td {
            color: #b0b0b0;
            font-size: 0.95rem;
        }

        .status {
            font-weight: 500;
            text-transform: uppercase;
            padding: 0.4rem 1rem;
            border-radius: 6px;
            display: inline-block;
            font-size: 0.75rem;
            letter-spacing: 1px;
            background: linear-gradient(135deg, #2a2a2a, #1f1f1f);
            color: #888;
            border: 1px solid #333;
        }

        .actions-cell {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 0.4rem 0.8rem;
            font-size: 0.7rem;
            border-radius: 4px;
            border: 1px solid #2a2a2a;
            background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
            color: #b0b0b0;
            cursor: pointer;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            border-color: #666;
            color: #fff;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(102, 102, 102, 0.2);
        }

        .action-btn.rebid {
            border-color: #3a3a1f;
            background: linear-gradient(135deg, #2a2a15, #1f1f10);
            color: #ffeb6b;
        }

        .action-btn.rebid:hover {
            border-color: #ffeb6b;
            box-shadow: 0 2px 8px rgba(255, 235, 107, 0.3);
        }

        .action-btn:active {
            transform: translateY(0);
        }

        .action-btn.delete {
            border-color: #5a1f1f;
            background: linear-gradient(135deg, #3a1515, #2a1010);
            color: #ff6b6b;
        }

        .action-btn.delete:hover {
            border-color: #ff6b6b;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
        }

        .action-btn.accept {
            border-color: #1f5a3a;
            background: linear-gradient(135deg, #153a25, #102a1a);
            color: #6bff9b;
        }

        .action-btn.accept:hover {
            border-color: #6bff9b;
            box-shadow: 0 2px 8px rgba(107, 255, 155, 0.3);
        }

        /* Mobile toggle button */
        .mobile-toggle {
            display: none;
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
            color: #ffffff;
            border: 1px solid #444;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            cursor: pointer;
            z-index: 1003;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.8);
            font-size: 1.5rem;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .mobile-toggle:hover {
            transform: scale(1.1);
            border-color: #666;
        }

        .mobile-toggle:active {
            transform: scale(0.95);
        }

        /* Sticky offer form */
        #new-offer-form {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 350px;
            background: linear-gradient(180deg, #1a1a1a 0%, #0f0f0f 100%);
            border-top: 1px solid #2a2a2a;
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.8);
            padding: 1.5rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            z-index: 1002;
        }

        #new-offer-form::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, #666, transparent);
        }

        #new-offer-form input, #new-offer-form button {
            padding: 0.9rem 1.5rem;
            font-size: 0.95rem;
            border-radius: 8px;
            border: 1px solid #2a2a2a;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        #new-offer-form input {
            background: linear-gradient(145deg, #1a1a1a, #0f0f0f);
            color: #ffffff;
            min-width: 200px;
        }

        #new-offer-form input:focus {
            outline: none;
            border-color: #555;
            box-shadow: 0 0 0 3px rgba(85, 85, 85, 0.2);
            background: #1f1f1f;
        }

        #new-offer-form input::placeholder {
            color: #555;
        }

        #new-offer-form input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #new-offer-form button {
            background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
            color: #ffffff;
            cursor: pointer;
            border: 1px solid #444;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 0.9rem 2.5rem;
            position: relative;
            overflow: hidden;
        }

        #new-offer-form button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s ease;
        }

        #new-offer-form button:hover {
            border-color: #666;
            box-shadow: 0 4px 20px rgba(102, 102, 102, 0.3);
        }

        #new-offer-form button:hover::before {
            left: 100%;
        }

        #new-offer-form button:active {
            transform: translateY(1px);
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #555;
            font-size: 1rem;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            right: 0;
            width: 350px;
            height: 100vh;
            background: linear-gradient(180deg, #1a1a1a 0%, #0f0f0f 100%);
            border-left: 1px solid #2a2a2a;
            box-shadow: -10px 0 40px rgba(0, 0, 0, 0.8);
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 2rem 1.5rem 1rem;
            border-bottom: 1px solid #2a2a2a;
            position: sticky;
            top: 0;
            background: linear-gradient(180deg, #1a1a1a 0%, #0f0f0f 100%);
            z-index: 10;
        }

        .sidebar-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, #666, transparent);
        }

        .sidebar-header h2 {
            color: #ffffff;
            font-size: 1.2rem;
            font-weight: 600;
            letter-spacing: -0.5px;
            margin-bottom: 0.5rem;
        }

        .sidebar-header p {
            color: #666;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .sidebar-close {
            display: none;
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: transparent;
            border: none;
            color: #666;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            transition: color 0.2s ease;
        }

        .sidebar-close:hover {
            color: #fff;
        }

        .users-list {
            padding: 1rem;
        }

        .user-card {
            background: linear-gradient(135deg, #1f1f1f 0%, #1a1a1a 100%);
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .user-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 3px;
            height: 100%;
            background: linear-gradient(180deg, #666, #444);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .user-card:hover {
            border-color: #444;
            background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
            transform: translateX(-3px);
        }

        .user-card:hover::before {
            opacity: 1;
        }

        .user-card.selected {
            border-color: #6bff9b;
            background: linear-gradient(135deg, #102a1a 0%, #153a25 100%);
        }

        .user-card.selected::before {
            background: linear-gradient(180deg, #6bff9b, #4dd87d);
            opacity: 1;
        }

        .user-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .user-name {
            color: #ffffff;
            font-weight: 500;
            font-size: 1rem;
        }

        .user-id {
            color: #666;
            font-size: 0.75rem;
            background: #0f0f0f;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }

        .user-card.selected .user-id {
            background: #1f3a2a;
            color: #6bff9b;
        }

        .user-info {
            color: #888;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .user-info strong {
            color: #aaa;
        }

        .user-email {
            color: #888;
            font-size: 0.8rem;
            margin-top: 0.3rem;
            font-family: 'Courier New', monospace;
        }

        .sidebar-loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .sidebar-error {
            text-align: center;
            padding: 2rem;
            color: #ff6b6b;
        }

        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .mobile-overlay.active {
            opacity: 1;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            body {
                padding: 1.5rem;
                padding-right: 1.5rem;
                margin-bottom: 140px;
            }

            .mobile-toggle {
                display: flex;
                bottom: 120px;
            }

            .sidebar {
                transform: translateX(100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .sidebar-close {
                display: block;
            }

            .mobile-overlay {
                display: block;
            }

            #new-offer-form {
                right: 0;
            }

            #new-offer-form input[name="userId"] {
                display: block;
                min-width: auto;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
                margin-bottom: 140px;
            }

            .container {
                padding: 1.5rem;
            }

            h1 {
                font-size: 2rem;
            }

            .sidebar {
                width: 100%;
                max-width: 350px;
            }

            #new-offer-form {
                flex-direction: column;
                padding: 1rem;
                gap: 0.75rem;
            }

            #new-offer-form input,
            #new-offer-form button {
                width: 100%;
                min-width: auto;
            }

            th, td {
                padding: 0.8rem 1rem;
                font-size: 0.85rem;
            }

            .action-btn {
                font-size: 0.65rem;
                padding: 0.3rem 0.6rem;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 1rem;
            }

            h1 {
                font-size: 1.5rem;
            }

            .item-details p {
                font-size: 0.9rem;
            }

            th, td {
                padding: 0.6rem 0.8rem;
                font-size: 0.8rem;
            }

            .mobile-toggle {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0f0f0f;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #444;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Offers for {{item.name}}</h1>

    <div class="item-details">
        <p><strong>Description:</strong> {{item.description}}</p>
        <p><strong>Base price:</strong> ${{item.price}}</p>
    </div>

    <div class="table-wrapper">
        <table id="offersTable">
            <thead>
            <tr>
                <th>ID</th>
                <th>User</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Created At</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody id="offersBody">
            {{#offers}}
                <tr data-offer-id="{{id}}">
                    <td>{{id}}</td>
                    <td>{{userName}}</td>
                    <td>${{amount}}</td>
                    <td><span class="status">{{status}}</span></td>
                    <td>{{createdAt}}</td>
                    <td class="actions-cell">
                        <button class="action-btn accept" onclick="updateOfferStatusAction({{id}}, 'accept')">Accept</button>
                        <button class="action-btn" onclick="updateOfferStatusAction({{id}}, 'reject')">Reject</button>
                        <button class="action-btn" onclick="updateOfferStatusAction({{id}}, 'cancel')">Cancel</button>
                        <button class="action-btn" onclick="updateOfferStatusAction({{id}}, 'complete')">Complete</button>
                        <button class="action-btn rebid" onclick="rebidOffer({{id}})">Rebid</button>
                        <button class="action-btn delete" onclick="deleteOffer({{id}})">Delete</button>
                    </td>
                </tr>
            {{/offers}}
            {{^offers}}
                <tr><td colspan="6" class="empty-state">No offers yet</td></tr>
            {{/offers}}
            </tbody>
        </table>
    </div>
</div>

<!-- Mobile overlay -->
<div class="mobile-overlay" id="mobileOverlay" onclick="closeSidebar()"></div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <button class="sidebar-close" onclick="closeSidebar()">âœ•</button>
        <h2>Available Users</h2>
        <p id="usersCount">Loading...</p>
    </div>
    <div id="usersList" class="users-list">
        <div class="sidebar-loading">Loading users...</div>
    </div>
</div>

<!-- Mobile toggle button -->
<button class="mobile-toggle" id="mobileToggle" onclick="toggleSidebar()">
    ðŸ‘¥
</button>

<!-- Sticky form -->
<form id="new-offer-form">
    <input type="number" name="userId" placeholder="User ID" min="1" required style="display: none;" />
    <input type="number" name="amount" placeholder="Offer amount" min="1" required />
    <button type="submit">Create Offer</button>
</form>

<script>
    const itemId = "{{item.id}}";
    const tableBody = document.getElementById("offersBody");
    let selectedUserId = null;
    let users = [];

    // Sidebar toggle functions
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('mobileOverlay');
        sidebar.classList.toggle('active');
        overlay.classList.toggle('active');
    }

    function closeSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('mobileOverlay');
        sidebar.classList.remove('active');
        overlay.classList.remove('active');
    }

    // Load users
    async function loadUsers() {
        try {
            const res = await fetch('/api/v1/users');
            if (!res.ok) throw new Error('Failed to fetch users');

            users = await res.json();
            renderUsers();
        } catch (err) {
            console.error('âŒ Error loading users:', err);
            document.getElementById('usersList').innerHTML = '<div class="sidebar-error">Failed to load users</div>';
        }
    }

    function renderUsers() {
        const usersList = document.getElementById('usersList');
        const usersCount = document.getElementById('usersCount');

        if (users.length === 0) {
            usersList.innerHTML = '<div class="sidebar-loading">No users available</div>';
            usersCount.textContent = '0 users';
            return;
        }

        usersCount.textContent = `${users.length} user${users.length !== 1 ? 's' : ''}`;

        usersList.innerHTML = users.map(user => `
            <div class="user-card" data-user-id="${user.id}" onclick="selectUser(${user.id})">
                <div class="user-card-header">
                    <span class="user-name">${user.name}</span>
                    <span class="user-id">ID: ${user.id}</span>
                </div>
                <div class="user-info">
                    <strong>Age:</strong> ${user.age || 'N/A'}
                </div>
                <div class="user-email">${user.email}</div>
            </div>
        `).join('');
    }

    function selectUser(userId) {
        selectedUserId = userId;

        // Update visual selection
        document.querySelectorAll('.user-card').forEach(card => {
            card.classList.remove('selected');
        });
        document.querySelector(`[data-user-id="${userId}"]`).classList.add('selected');

        // Update form
        const userIdInput = document.querySelector('#new-offer-form input[name="userId"]');
        userIdInput.value = userId;

        // Enable amount input on mobile
        const amountInput = document.querySelector('#new-offer-form input[name="amount"]');
        amountInput.disabled = false;
        amountInput.focus();

        // Close sidebar on mobile after selection
        if (window.innerWidth <= 1024) {
            setTimeout(closeSidebar, 300);
        }
    }

    // WebSocket for offers
    const ws = new WebSocket(`ws://${window.location.host}/ws/offers?itemId=${itemId}`);
    ws.onopen = () => console.log("âœ… Connected to offers WebSocket for item", itemId);
    ws.onclose = () => console.log("ðŸ”´ Disconnected from offers WebSocket");
    ws.onerror = (err) => console.error("WebSocket error:", err);

    ws.onmessage = (msg) => {
        let parsed;
        try {
            parsed = JSON.parse(msg.data);
        } catch (e) {
            console.error("Invalid WS data", msg.data);
            return;
        }

        const { eventType, data } = parsed;
        const offer = typeof data === "string" ? JSON.parse(data) : data;
        console.log("ðŸ“© Offer event received:", eventType, offer);

        switch (eventType) {
            case "OFFER_CREATED":
            case "OFFER_UPDATED":
            case "OFFER_REBID":
                upsertOfferRow(offer);
                break;
            case "OFFER_DELETED":
                removeOfferRow(offer.id);
                break;
            case "OFFER_REJECTED":
            case "OFFER_CANCELLED":
            case "OFFER_COMPLETED":
            case "OFFER_ACCEPTED":
                updateOfferStatusDisplay(offer);
                break;
        }
    };

    function updateOfferStatusDisplay(offer) {
        const row = document.querySelector(`tr[data-offer-id='${offer.id}']`);
        if (!row) return;
        row.querySelector(".status").textContent = offer.status;
    }

    function upsertOfferRow(offer) {
        const emptyRow = document.querySelector('.empty-state');
        if (emptyRow && emptyRow.closest('tr')) {
            emptyRow.closest('tr').remove();
        }

        let row = document.querySelector(`tr[data-offer-id='${offer.id}']`);
        if (!row) {
            row = document.createElement("tr");
            row.dataset.offerId = offer.id;
            row.innerHTML = `
                <td>${offer.id}</td>
                <td>${offer.userName}</td>
                <td>$${offer.amount}</td>
                <td><span class="status">${offer.status}</span></td>
                <td>${offer.createdAt}</td>
                <td class="actions-cell">
                    <button class="action-btn accept" onclick="updateOfferStatusAction(${offer.id}, 'accept')">Accept</button>
                    <button class="action-btn" onclick="updateOfferStatusAction(${offer.id}, 'reject')">Reject</button>
                    <button class="action-btn" onclick="updateOfferStatusAction(${offer.id}, 'cancel')">Cancel</button>
                    <button class="action-btn" onclick="updateOfferStatusAction(${offer.id}, 'complete')">Complete</button>
                    <button class="action-btn rebid" onclick="rebidOffer(${offer.id})">Rebid</button>
                    <button class="action-btn delete" onclick="deleteOffer(${offer.id})">Delete</button>
                </td>
            `;
            tableBody.appendChild(row);
        } else {
            row.querySelector("td:nth-child(2)").textContent = offer.userName;
            row.querySelector("td:nth-child(3)").textContent = `$${offer.amount}`;
            row.querySelector(".status").textContent = offer.status;
            row.querySelector("td:nth-child(5)").textContent = offer.createdAt;
        }
    }

    function removeOfferRow(id) {
        const row = document.querySelector(`tr[data-offer-id='${id}']`);
        if (row) row.remove();
    }

    // Actions
    async function updateOfferStatusAction(offerId, status) {
        try {
            const res = await fetch(`/api/v1/offers/${offerId}/${status}`, {
                method: "PUT"
            });

            if (!res.ok) throw new Error(await res.text());
            console.log(`âœ… Offer ${offerId} status updated to ${status}`);
        } catch (err) {
            console.error(`âŒ Error updating offer status:`, err);
            alert(`Failed to update offer status. Check console for details.`);
        }
    }

    async function deleteOffer(offerId) {
        if (!confirm(`Are you sure you want to delete offer #${offerId}?`)) return;

        try {
            const res = await fetch(`/api/v1/offers/${offerId}`, {
                method: "DELETE"
            });

            if (!res.ok) throw new Error(await res.text());
            console.log(`âœ… Offer ${offerId} deleted`);
        } catch (err) {
            console.error(`âŒ Error deleting offer:`, err);
            alert(`Failed to delete offer. Check console for details.`);
        }
    }

    async function rebidOffer(offerId) {
        const newAmount = prompt('Enter new offer amount:');
        if (!newAmount || isNaN(newAmount) || Number(newAmount) <= 0) {
            return;
        }

        try {
            const res = await fetch(`/api/v1/offers/${offerId}/amount`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ amount: Number(newAmount) })
            });

            if (!res.ok) throw new Error(await res.text());
            console.log(`âœ… Offer ${offerId} rebid to ${newAmount}`);
        } catch (err) {
            console.error(`âŒ Error rebidding offer:`, err);
            alert(`Failed to rebid offer. Check console for details.`);
        }
    }

    // ---- Table sorting logic ----
    const getCellValue = (tr, idx) => tr.children[idx].innerText || tr.children[idx].textContent;

    const comparer = (idx, asc) => (a, b) =>
            ((v1, v2) =>
                            v1 !== "" && v2 !== "" && !isNaN(v1) && !isNaN(v2)
                                    ? v1 - v2
                                    : v1.toString().localeCompare(v2)
            )(getCellValue(asc ? a : b, idx), getCellValue(asc ? b : a, idx));

    document.querySelectorAll("th").forEach((th, idx) =>
            th.addEventListener("click", () => {
                const table = th.closest("table");
                Array.from(table.querySelectorAll("tbody tr"))
                        .sort(comparer(idx, (this.asc = !this.asc)))
                        .forEach(tr => table.querySelector("tbody").appendChild(tr));
            })
    );

    // ---- Sticky form ----
    document.getElementById("new-offer-form").addEventListener("submit", async (e) => {
        e.preventDefault();

        if (!selectedUserId) {
            alert('Please select a user from the sidebar first');
            return;
        }

        const form = e.target;
        const finalPrice = form.amount.value;

        const payload = {
            userId: selectedUserId,
            itemId: Number(itemId),
            finalPrice: Number(finalPrice)
        };

        try {
            const res = await fetch("/api/v1/offers", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (!res.ok) throw new Error(await res.text());
            form.amount.value = '';
            console.log("âœ… Offer created successfully");
        } catch (err) {
            console.error("âŒ Error creating offer:", err);
            alert("Failed to create offer. Check console for details.");
        }
    });

    // Initialize
    loadUsers();
</script>

</body>
</html>
